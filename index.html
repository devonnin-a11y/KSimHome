<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KSim Home ‚Äì Kelly HUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1f3f4a" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #f4eee7;
      --bg-soft: #f9f4ee;
      --bg-card: #ffffff;
      --border-soft: #e1d2c4;
      --accent: #00b2c8; /* Sims-ish teal */
      --accent-soft: #93dde6;
      --accent-dark: #007e8f;
      --text-main: #2a221a;
      --text-soft: #756458;
      --danger: #c4475e;
      --good: #3fa76a;
      --neutral: #f6c15b;
      --low: #e45b5b;
      --hud-bg: #1f3f4a;
      --hud-soft: #284a57;
      --hud-outline: #c2f5ff;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.10);
      --shadow-hud: 0 14px 40px rgba(0,0,0,0.35);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #fffaf3 0, #f0e6d6 45%, #e3d3c2 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 98px; /* space for HUD */
    }

    body.simple-mode [data-simple-hide="true"] {
      display: none !important;
    }

    .app-shell {
      max-width: 520px;
      margin: 0 auto;
      padding: 8px 10px 16px;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(0,178,200,0.15), rgba(179,117,72,0.08));
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      backdrop-filter: blur(8px);
    }

    .top-bar-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-bar-logo {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #fff, #1f3f4a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f7fbff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.4);
    }

    .top-bar-text-main {
      font-weight: 600;
      letter-spacing: 0.02em;
      font-size: 15px;
    }

    .top-bar-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .top-bar-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .btn-pill {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(10,10,10,0.04);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
    }

    .btn-pill span.icon {
      font-size: 13px;
    }

    .btn-pill:active {
      transform: scale(0.97);
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      margin: 8px 0 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 999px;
      padding: 3px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .tab-button {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 7px 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
    }

    .tab-button-icon {
      font-size: 14px;
    }

    .tab-button.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    .tab-button.active .tab-button-icon {
      transform: translateY(-0.5px);
    }

    /* Layout cards */
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      border: 1px solid var(--border-soft);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-icon {
      font-size: 15px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    /* Daily quests */
    .quest-list {
      list-style: none;
      margin: 2px 0 6px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quest-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      background: var(--bg-soft);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .quest-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .quest-text {
      font-size: 13px;
      flex: 1;
    }

    .quest-item.completed {
      opacity: 0.8;
    }

    .quest-item.completed .quest-text {
      text-decoration: line-through;
      color: var(--text-soft);
    }

    .badge-soft {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.02);
      padding: 2px 7px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .btn-soft {
      appearance: none;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #f8d0d0, #e194a2);
      color: #3b1221;
      padding: 7px 10px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .btn-soft.bad-day-active {
      background: linear-gradient(135deg, #d5e6ff, #99c1ff);
      color: #153057;
    }

    .muted-text {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* Feelings */
    .feelings-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .feeling-btn {
      flex: 1 0 calc(33.33% - 4px);
      border: none;
      border-radius: var(--radius-md);
      font-size: 11px;
      padding: 6px 6px;
      cursor: pointer;
      background: #f3eee8;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 0;
    }

    .feeling-btn span.icon {
      font-size: 13px;
    }

    .feeling-btn[data-tone="good"] { background: #e5f5ea; }
    .feeling-btn[data-tone="neutral"] { background: #fef3dc; }
    .feeling-btn[data-tone="low"] { background: #fbe6e6; }

    .feeling-message {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    /* Timers */
    .timer-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .timer-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      background: #f5f1ea;
    }

    .timer-label-main {
      font-size: 12px;
      font-weight: 500;
    }

    .timer-label-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .timer-status {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      min-width: 66px;
      text-align: center;
    }

    .timer-status.due {
      background: rgba(228,91,91,0.12);
      color: var(--low);
    }

    .timer-cta {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }

    .btn-timer {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
    }

    .btn-timer.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
    }

    /* Stats & Needs */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .stat-pill {
      flex: 1 0 calc(50% - 4px);
      border-radius: var(--radius-md);
      padding: 6px 7px;
      background: #f5efe8;
      font-size: 11px;
    }

    .stat-pill-label {
      color: var(--text-soft);
      font-size: 10px;
    }

    .stat-pill-value {
      font-weight: 600;
      margin-top: 2px;
    }

    .level-bar-wrap {
      margin-top: 8px;
    }

    .level-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .level-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .level-bar {
      width: 100%;
      height: 8px;
      background: rgba(0,0,0,0.06);
      border-radius: 999px;
      overflow: hidden;
    }

    .level-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--accent-soft), var(--accent-dark));
      transition: width 0.25s ease;
    }

    .needs-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .need-row {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) 2fr auto;
      gap: 8px;
      align-items: center;
    }

    .need-label {
      font-size: 12px;
      font-weight: 500;
    }

    .need-bar-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      overflow: hidden;
      position: relative;
    }

    .need-bar-fill {
      height: 100%;
      width: 50%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.25s ease;
    }

    .need-bar-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 3px rgba(0,0,0,0.25);
      pointer-events: none;
    }

    .need-controls {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-need {
      border-radius: 999px;
      border: none;
      padding: 2px 7px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
    }

    .need-value {
      font-size: 11px;
      color: var(--text-soft);
      min-width: 32px;
      text-align: right;
    }

    /* Journals & Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 6px;
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 9px;
      color: var(--text-soft);
      text-align: center;
      margin-top: 4px;
    }

    .calendar-day {
      font-size: 11px;
      padding: 4px 0;
      border-radius: 999px;
      text-align: center;
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(0,0,0,0.04);
      position: relative;
    }

    .calendar-day.win::after {
      content: "‚òÖ";
      position: absolute;
      top: 1px;
      right: 4px;
      font-size: 9px;
      color: var(--accent);
    }

    .calendar-day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,178,200,0.6);
      font-weight: 600;
    }

    .calendar-month-label {
      font-size: 12px;
      font-weight: 600;
    }

    .journal-group {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .journal-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .journal-textarea {
      width: 100%;
      min-height: 68px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #fbf6ee;
      padding: 8px;
      font-size: 12px;
      resize: vertical;
      font-family: inherit;
    }

    /* HUD */
    .hud-shell {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 8px 8px;
      pointer-events: none;
      z-index: 40;
    }

    .hud-inner {
      max-width: 520px;
      margin: 0 auto;
      background: radial-gradient(circle at top, #3f6f7f 0, #13242b 60%, #091015 100%);
      border-radius: 22px 22px 8px 8px;
      border: 1px solid #283c46;
      box-shadow: var(--shadow-hud);
      padding: 8px 10px 6px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
      pointer-events: auto;
      position: relative;
    }

    .hud-inner::before {
      content: "";
      position: absolute;
      inset: 1px 1px auto;
      border-radius: 20px 20px 6px 6px;
      border-top: 1px solid rgba(255,255,255,0.12);
      pointer-events: none;
    }

    .hud-portrait {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .portrait-frame {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #fff, #4e2c1e);
      border: 2px solid var(--hud-outline);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fdf9f2;
      font-size: 22px;
      font-weight: 700;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.5);
    }

    .portrait-meta {
      font-size: 11px;
      color: #e7f7ff;
    }

    .portrait-meta-name {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 11px;
    }

    .portrait-meta-sub {
      font-size: 10px;
      color: #b9d1db;
    }

    .hud-mood {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .plumbob-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .plumbob {
      width: 18px;
      height: 26px;
      position: relative;
      transform: translateY(0);
    }

    .plumbob-shape {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, #4df18d, #178348);
      clip-path: polygon(50% 0, 100% 50%, 50% 100%, 0 50%);
      box-shadow: 0 0 10px rgba(154,255,180,0.85);
    }

    .plumbob.low {
      filter: hue-rotate(-35deg) brightness(0.9);
    }
    .plumbob.neutral {
      filter: hue-rotate(40deg);
    }
    .plumbob.good {
      filter: hue-rotate(75deg) saturate(1.1);
    }

    .mood-label-main {
      font-size: 12px;
      font-weight: 600;
      color: #f6fbff;
    }

    .mood-label-sub {
      font-size: 11px;
      color: #bfd7e0;
    }

    .mood-gauge-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.5);
      overflow: hidden;
      position: relative;
    }

    .mood-gauge-fill {
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.25s ease;
    }

    .mood-gauge-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.7);
    }

    .hud-dots {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .dot-row {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.24);
    }

    .dot.on {
      background: #e7f6ff;
      box-shadow: 0 0 5px rgba(202,246,255,0.9);
    }

    .dot-label {
      font-size: 10px;
      color: #c8dde6;
      margin-right: 4px;
    }

    .hud-hint {
      font-size: 9px;
      color: #8ea6b2;
    }

    @media (min-width: 640px) {
      body {
        padding-top: 10px;
      }
      .top-bar {
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- TOP BAR -->
    <header class="top-bar">
      <div class="top-bar-title">
        <div class="top-bar-logo">K</div>
        <div>
          <div class="top-bar-text-main">KSim Home</div>
          <div class="top-bar-text-sub">Kelly‚Äôs cozy day HUD</div>
        </div>
      </div>
      <div class="top-bar-meta">
        <div class="chip" id="dayChip">
          <span class="chip-dot"></span>
          <span>Today</span>
        </div>
        <button class="btn-pill" id="simpleToggle" type="button">
          <span class="icon">üåø</span>
          <span>Simple view</span>
        </button>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tab-bar">
      <button class="tab-button active" data-tab-target="dashboard" type="button">
        <span class="tab-button-icon">üè†</span>
        <span>Dashboard</span>
      </button>
      <button class="tab-button" data-tab-target="needs" type="button">
        <span class="tab-button-icon">üìä</span>
        <span>Needs &amp; Stats</span>
      </button>
      <button class="tab-button" data-tab-target="journals" type="button">
        <span class="tab-button-icon">üìñ</span>
        <span>Journals</span>
      </button>
    </nav>

    <main>
      <!-- DASHBOARD TAB -->
      <section class="tab-panel active" data-tab="dashboard">
        <!-- Daily quests -->
        <section class="card" id="questsCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">‚ú®</span>
              <span>Daily house quests</span>
            </div>
            <span class="badge-soft" id="questsSummary">0 / 2 done</span>
          </div>
          <p class="card-subtitle">
            Only two tiny quests. If today is heavy, you still win just for showing up.
          </p>
          <ul class="quest-list" id="questList">
            <!-- Filled by JS -->
          </ul>
          <button class="btn-soft" id="badDayButton" type="button">
            <span>Had a rough day?</span>
            <span>üíó</span>
          </button>
          <div class="muted-text" id="badDayMessage">
            Tap if the day just‚Ä¶ wasn‚Äôt it. It still counts as a win on the calendar.
          </div>
        </section>

        <!-- Feelings -->
        <section class="card" id="feelingsCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üß†</span>
              <span>How are you feeling?</span>
            </div>
          </div>
          <p class="card-subtitle">
            Tap what fits closest. No fixing required ‚Äî this just helps your ‚ÄúSim self‚Äù be seen.
          </p>
          <div class="feelings-strip">
            <!-- low -->
            <button class="feeling-btn" data-feeling="stressed" data-tone="low" data-category="low" type="button">
              <span class="icon">‚ö°</span><span>Stressed</span>
            </button>
            <button class="feeling-btn" data-feeling="overwhelmed" data-tone="low" data-category="low" type="button">
              <span class="icon">üåä</span><span>Overwhelmed</span>
            </button>
            <button class="feeling-btn" data-feeling="low" data-tone="low" data-category="low" type="button">
              <span class="icon">üåßÔ∏è</span><span>Low</span>
            </button>
            <button class="feeling-btn" data-feeling="sad" data-tone="low" data-category="low" type="button">
              <span class="icon">üíß</span><span>Sad</span>
            </button>
            <button class="feeling-btn" data-feeling="angry" data-tone="low" data-category="low" type="button">
              <span class="icon">üî•</span><span>Angry</span>
            </button>
            <button class="feeling-btn" data-feeling="hungry" data-tone="neutral" data-category="neutral" type="button">
              <span class="icon">üçû</span><span>Hungry</span>
            </button>
            <!-- neutral/good -->
            <button class="feeling-btn" data-feeling="good" data-tone="good" data-category="good" type="button">
              <span class="icon">üôÇ</span><span>Good</span>
            </button>
            <button class="feeling-btn" data-feeling="happy" data-tone="good" data-category="good" type="button">
              <span class="icon">üòä</span><span>Happy</span>
            </button>
            <button class="feeling-btn" data-feeling="peace" data-tone="good" data-category="good" type="button">
              <span class="icon">üïäÔ∏è</span><span>Peace</span>
            </button>
            <button class="feeling-btn" data-feeling="ease" data-tone="good" data-category="good" type="button">
              <span class="icon">üåø</span><span>Ease</span>
            </button>
          </div>
          <div class="feeling-message" id="feelingMessage">
            Your feelings are information, not a to-do list. Whatever you tapped is valid.
          </div>
        </section>

        <!-- Timers -->
        <section class="card" id="timersCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">‚è±Ô∏è</span>
              <span>Gentle check-in timers</span>
            </div>
          </div>
          <p class="card-subtitle">
            These are soft nudges. If they expire and you do nothing, you‚Äôre still a good mom.
          </p>
          <div class="timer-list">
            <!-- Each row uses data-timer-id -->
            <div class="timer-row" data-timer-id="hydration">
              <div>
                <div class="timer-label-main">Hydration</div>
                <div class="timer-label-sub">Sip water or tea</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="meal">
              <div>
                <div class="timer-label-main">Meal</div>
                <div class="timer-label-sub">Real food for you</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="snack">
              <div>
                <div class="timer-label-main">Snack</div>
                <div class="timer-label-sub">Quick energy boost</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="bathroom">
              <div>
                <div class="timer-label-main">Bathroom break</div>
                <div class="timer-label-sub">Your body matters too</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="shower" data-simple-hide="true">
              <div>
                <div class="timer-label-main">Hot shower</div>
                <div class="timer-label-sub">Steam, breathe, reset</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="skincare" data-simple-hide="true">
              <div>
                <div class="timer-label-main">Skincare</div>
                <div class="timer-label-sub">Tiny goddess ritual</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- NEEDS & STATS TAB -->
      <section class="tab-panel" data-tab="needs">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üõ°Ô∏è</span>
              <span>Solopa Viking stats</span>
            </div>
          </div>
          <p class="card-subtitle">
            These grow quietly in the background as you do tiny things, not giant ones.
          </p>
          <div class="stats-row">
            <div class="stat-pill">
              <div class="stat-pill-label">Quests completed</div>
              <div class="stat-pill-value" id="statQuests">0</div>
            </div>
            <div class="stat-pill">
              <div class="stat-pill-label">Days counted as wins</div>
              <div class="stat-pill-value" id="statWins">0</div>
            </div>
            <div class="stat-pill" data-simple-hide="true">
              <div class="stat-pill-label">Self-care bonuses</div>
              <div class="stat-pill-value" id="statSelfCare">0</div>
            </div>
            <div class="stat-pill" data-simple-hide="true">
              <div class="stat-pill-label">Feelings check-ins</div>
              <div class="stat-pill-value" id="statFeelings">0</div>
            </div>
          </div>
          <div class="level-bar-wrap">
            <div class="level-label">Solopa Viking level</div>
            <div class="level-name" id="levelName">Hearth Seedling</div>
            <div class="level-bar">
              <div class="level-fill" id="levelFill"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üíö</span>
              <span>Needs check-in</span>
            </div>
          </div>
          <p class="card-subtitle">
            Nudge these up or down based on how real-life Kelly feels ‚Äî not how she ‚Äúshould.‚Äù
          </p>
          <div class="needs-list">
            <!-- Each row: data-need-id -->
            <div class="need-row" data-need-id="hunger">
              <div class="need-label">Hunger</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="energy">
              <div class="need-label">Energy</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="social">
              <div class="need-label">Social</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="fun">
              <div class="need-label">Fun</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="hygiene" data-simple-hide="true">
              <div class="need-label">Hygiene</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="quiet" data-simple-hide="true">
              <div class="need-label">Quiet / Alone</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- JOURNALS TAB -->
      <section class="tab-panel" data-tab="journals">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üóìÔ∏è</span>
              <span>Win-the-day calendar</span>
            </div>
            <span class="calendar-month-label" id="calendarMonthLabel"></span>
          </div>
          <p class="card-subtitle">
            A day is a ‚Äúwin‚Äù if you did any quest <em>or</em> tapped ‚ÄúHad a rough day?‚Äù.
          </p>
          <div class="calendar-header">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </section>

        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üìì</span>
              <span>Journals</span>
            </div>
          </div>
          <div class="journal-group">
            <div>
              <div class="journal-label">Today‚Äôs little log</div>
              <textarea class="journal-textarea" id="journalDay" placeholder="A few lines about today is plenty."></textarea>
            </div>
            <div data-simple-hide="true">
              <div class="journal-label">This month‚Äôs story</div>
              <textarea class="journal-textarea" id="journalMonth" placeholder="What this month feels like overall‚Ä¶"></textarea>
            </div>
            <div data-simple-hide="true">
              <div class="journal-label">This year‚Äôs chapter</div>
              <textarea class="journal-textarea" id="journalYear" placeholder="Big picture thoughts that future you might smile at."></textarea>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- HUD -->
  <div class="hud-shell">
    <div class="hud-inner">
      <div class="hud-portrait">
        <div class="portrait-frame">K</div>
        <div class="portrait-meta">
          <div class="portrait-meta-name">Kelly</div>
          <div class="portrait-meta-sub" id="hudSubtext">Solopa Hearthling</div>
        </div>
      </div>
      <div class="hud-mood">
        <div class="plumbob-wrap">
          <div class="plumbob" id="plumbob">
            <div class="plumbob-shape"></div>
          </div>
          <div>
            <div class="mood-label-main" id="moodLabelMain">Gently okay</div>
            <div class="mood-label-sub" id="moodLabelSub">You‚Äôre doing more than enough.</div>
          </div>
        </div>
        <div class="mood-gauge-shell">
          <div class="mood-gauge-fill" id="moodGaugeFill"></div>
        </div>
      </div>
      <div class="hud-dots">
        <div class="dot-row">
          <span class="dot-label">Needs</span>
          <span class="dot" id="dot1"></span>
          <span class="dot" id="dot2"></span>
          <span class="dot" id="dot3"></span>
        </div>
        <div class="hud-hint">Tap anything gently. Nothing here can fail.</div>
      </div>
    </div>
  </div>

  <!-- AUDIO -->
  <audio data-sound="ui-click" src="sounds/ui-click.mp3" preload="auto"></audio>
  <audio data-sound="feel-good" src="sounds/feel-good.mp3" preload="auto"></audio>
  <audio data-sound="feel-neutral" src="sounds/feel-neutral.mp3" preload="auto"></audio>
  <audio data-sound="feel-low" src="sounds/feel-low.mp3" preload="auto"></audio>

  <script>
    (function () {
      const STORAGE_KEY = "ksimHomeState_v1";

      const defaultTimersConfig = {
        hydration: { minutes: 60 },
        meal: { minutes: 180 },
        snack: { minutes: 120 },
        bathroom: { minutes: 90 },
        shower: { minutes: 30 },
        skincare: { minutes: 45 }
      };

      const tasksPool = [
        "Clear and wipe the kitchen counters",
        "Sweep the living room floor",
        "Fold one mini-load of laundry",
        "Tidy toys from one room",
        "Reset the bathroom sink area",
        "Wipe the dining table",
        "Quick vacuum of main hallway",
        "Put away clean dishes / run dishwasher",
        "Declutter one small surface",
        "Start or switch one load of laundry"
      ];

      const levelNames = [
        "Hearth Seedling",
        "Cozy Sprout",
        "Ember Keeper",
        "Hearth Guardian",
        "Solopa Shield-Maiden",
        "Homestead High Priestess"
      ];

      function todayDateString() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function getMonthKey(dateStr) {
        return dateStr.slice(0, 7); // YYYY-MM
      }

      function getYearKey(dateStr) {
        return dateStr.slice(0, 4);
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return createFreshState();
        }
        try {
          const parsed = JSON.parse(raw);
          return migrateState(parsed);
        } catch {
          return createFreshState();
        }
      }

      function createFreshState() {
        const today = todayDateString();
        return {
          version: 1,
          todayDate: today,
          today: {
            tasks: [],
            completedTaskIds: [],
            badDay: false
          },
          winsByDate: {},
          needs: {
            hunger: 60,
            energy: 60,
            social: 60,
            fun: 60,
            hygiene: 60,
            quiet: 60
          },
          stats: {
            questsCompleted: 0,
            daysWin: 0,
            selfCareBonuses: 0,
            feelingsCheckins: 0
          },
          mood: {
            score: 60,
            labelMain: "Gently okay",
            labelSub: "You‚Äôre doing more than enough.",
            tone: "neutral"
          },
          timers: initTimersState(),
          journals: {
            day: {},   // key: YYYY-MM-DD
            month: {}, // key: YYYY-MM
            year: {}   // key: YYYY
          }
        };
      }

      function migrateState(state) {
        // Basic migration scaffolding if we change versions later.
        if (!state.version) state.version = 1;
        if (!state.timers) state.timers = initTimersState();
        if (!state.journals) {
          state.journals = { day: {}, month: {}, year: {} };
        }
        return state;
      }

      function initTimersState() {
        const base = {};
        for (const id in defaultTimersConfig) {
          base[id] = {
            durationMinutes: defaultTimersConfig[id].minutes,
            remainingMs: 0,
            isRunning: false,
            lastStart: null,
            completedCount: 0
          };
        }
        return base;
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function ensureToday() {
        const todayStr = todayDateString();
        if (state.todayDate === todayStr && state.today.tasks && state.today.tasks.length) {
          return;
        }

        // If date changed, keep stats and winsByDate; refresh today's entry.
        state.todayDate = todayStr;
        state.today = {
          tasks: pickTodayTasks(todayStr),
          completedTaskIds: [],
          badDay: false
        };
      }

      function pickTodayTasks(dateStr) {
        // Deterministic pseudo selection based on date
        const d = new Date(dateStr + "T00:00:00");
        const seed = d.getDate() + (d.getMonth() + 1) * 13;
        const index1 = seed % tasksPool.length;
        const index2 = (seed * 5 + 3) % tasksPool.length;
        const ids = [index1, index2 === index1 ? (index2 + 1) % tasksPool.length : index2];
        return ids.map(id => ({ id, text: tasksPool[id] }));
      }

      function playSound(name) {
        const audio = document.querySelector(`audio[data-sound="${name}"]`);
        if (!audio) return;
        try {
          audio.currentTime = 0;
          audio.play().catch(() => {});
        } catch {}
      }

      function uiClick() {
        playSound("ui-click");
      }

      // --- State + DOM references ---
      let state = loadState();
      ensureToday();

      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const dayChip = document.getElementById("dayChip");
      const simpleToggle = document.getElementById("simpleToggle");

      const questList = document.getElementById("questList");
      const questsSummary = document.getElementById("questsSummary");
      const badDayButton = document.getElementById("badDayButton");
      const badDayMessage = document.getElementById("badDayMessage");

      const feelingMessage = document.getElementById("feelingMessage");

      const statQuests = document.getElementById("statQuests");
      const statWins = document.getElementById("statWins");
      const statSelfCare = document.getElementById("statSelfCare");
      const statFeelings = document.getElementById("statFeelings");
      const levelNameEl = document.getElementById("levelName");
      const levelFill = document.getElementById("levelFill");

      const calendarMonthLabel = document.getElementById("calendarMonthLabel");
      const calendarGrid = document.getElementById("calendarGrid");

      const journalDay = document.getElementById("journalDay");
      const journalMonth = document.getElementById("journalMonth");
      const journalYear = document.getElementById("journalYear");

      const plumbob = document.getElementById("plumbob");
      const moodLabelMain = document.getElementById("moodLabelMain");
      const moodLabelSub = document.getElementById("moodLabelSub");
      const moodGaugeFill = document.getElementById("moodGaugeFill");
      const hudSubtext = document.getElementById("hudSubtext");
      const dot1 = document.getElementById("dot1");
      const dot2 = document.getElementById("dot2");
      const dot3 = document.getElementById("dot3");

      let timersInterval = null;

      // --- Initial render ---
      renderDayChip();
      renderQuests();
      renderBadDay();
      renderStats();
      renderNeeds();
      renderMood();
      renderCalendar();
      renderJournals();
      startTimersTick();

      // --- Event wiring ---

      // Generic UI click sound for buttons
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (btn) {
          uiClick();
        }
      });

      // Tabs
      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab-target");
          tabButtons.forEach(b => b.classList.toggle("active", b === btn));
          tabPanels.forEach(p => p.classList.toggle("active", p.getAttribute("data-tab") === target));
        });
      });

      // Simple view toggle
      simpleToggle.addEventListener("click", () => {
        document.body.classList.toggle("simple-mode");
      });

      // Quests checkbox handling
      questList.addEventListener("change", (e) => {
        if (e.target.matches('input[type="checkbox"][data-quest-id]')) {
          const questId = parseInt(e.target.getAttribute("data-quest-id"), 10);
          const completed = state.today.completedTaskIds;
          const already = completed.includes(questId);
          if (e.target.checked && !already) {
            completed.push(questId);
            state.stats.questsCompleted += 1;
          } else if (!e.target.checked && already) {
            const idx = completed.indexOf(questId);
            if (idx >= 0) completed.splice(idx, 1);
            state.stats.questsCompleted = Math.max(0, state.stats.questsCompleted - 1);
          }
          updateWinFlagForToday();
          renderQuests();
          renderStats();
          renderCalendar();
          saveState();
        }
      });

      // Bad day button
      badDayButton.addEventListener("click", () => {
        state.today.badDay = !state.today.badDay;
        updateWinFlagForToday();
        renderBadDay();
        renderStats();
        renderCalendar();
        saveState();
      });

      // Feelings
      document.getElementById("feelingsCard").addEventListener("click", (e) => {
        const btn = e.target.closest(".feeling-btn");
        if (!btn) return;
        const category = btn.getAttribute("data-category");
        const tone = btn.getAttribute("data-tone");
        const feelingKey = btn.getAttribute("data-feeling");

        handleFeeling(feelingKey, category, tone);
      });

      // Timers
      document.getElementById("timersCard").addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-timer");
        if (!btn) return;
        const row = btn.closest(".timer-row");
        const timerId = row.getAttribute("data-timer-id");
        const action = btn.getAttribute("data-timer-action");
        if (action === "start") {
          startTimer(timerId);
        } else if (action === "stop") {
          stopTimer(timerId);
        }
      });

      // Needs +/- buttons
      document.querySelectorAll(".need-row").forEach(row => {
        row.addEventListener("click", (e) => {
          const btn = e.target.closest(".btn-need");
          if (!btn) return;
          const delta = parseInt(btn.getAttribute("data-need-delta"), 10);
          const needId = row.getAttribute("data-need-id");
          adjustNeed(needId, delta);
        });
      });

      // Journals
      journalDay.addEventListener("input", () => {
        const key = state.todayDate;
        state.journals.day[key] = journalDay.value;
        saveState();
      });
      journalMonth.addEventListener("input", () => {
        const key = getMonthKey(state.todayDate);
        state.journals.month[key] = journalMonth.value;
        saveState();
      });
      journalYear.addEventListener("input", () => {
        const key = getYearKey(state.todayDate);
        state.journals.year[key] = journalYear.value;
        saveState();
      });

      // --- Handlers and render helpers ---

      function renderDayChip() {
        const d = new Date(state.todayDate + "T00:00:00");
        const options = { weekday: "short", month: "short", day: "numeric" };
        const label = d.toLocaleDateString(undefined, options);
        dayChip.querySelector("span:nth-child(2)").textContent = label;
      }

      function renderQuests() {
        ensureToday();
        questList.innerHTML = "";
        state.today.tasks.forEach(t => {
          const li = document.createElement("li");
          li.className = "quest-item";
          if (state.today.completedTaskIds.includes(t.id)) {
            li.classList.add("completed");
          }
          li.innerHTML = `
            <input type="checkbox" data-quest-id="${t.id}" ${state.today.completedTaskIds.includes(t.id) ? "checked" : ""}/>
            <div class="quest-text">${t.text}</div>
          `;
          questList.appendChild(li);
        });
        questsSummary.textContent = `${state.today.completedTaskIds.length} / ${state.today.tasks.length} done`;
      }

      function renderBadDay() {
        if (state.today.badDay) {
          badDayButton.classList.add("bad-day-active");
          badDayButton.textContent = "Bad day logged ‚Äî you still win üíó";
          badDayMessage.textContent = "This day is marked as a win because you survived it. That‚Äôs enough.";
        } else {
          badDayButton.classList.remove("bad-day-active");
          badDayButton.textContent = "Had a rough day? üíó";
          badDayMessage.textContent = "Tap if the day just‚Ä¶ wasn‚Äôt it. It still counts as a win on the calendar.";
        }
      }

      function handleFeeling(feelingKey, category, tone) {
        state.stats.feelingsCheckins += 1;

        let delta = 0;
        if (category === "good") delta = +8;
        else if (category === "neutral") delta = 0;
        else if (category === "low") delta = -8;

        state.mood.score = clamp(state.mood.score + delta, 0, 100);

        let msg = "";
        let sub = "";
        switch (feelingKey) {
          case "stressed":
            msg = "Stressed & still showing up";
            sub = "Your brain is juggling a lot. You are not failing ‚Äî you‚Äôre overloaded.";
            break;
          case "overwhelmed":
            msg = "Overwhelmed, not weak";
            sub = "Too much on one person is a system issue, not a you issue.";
            break;
          case "low":
            msg = "Low battery";
            sub = "Low mood is a signal, not a verdict on your worth.";
            break;
          case "sad":
            msg = "Heavy heart";
            sub = "You‚Äôre allowed to be soft and sad and still be a powerful mom.";
            break;
          case "angry":
            msg = "Fire in the hearth";
            sub = "Anger is your body guarding your boundaries, not you being ‚Äòtoo much‚Äô.";
            break;
          case "hungry":
            msg = "Body needs fuel";
            sub = "Food for you is a family upgrade, not selfish.";
            break;
          case "good":
            msg = "Gently good";
            sub = "Notice this softness ‚Äî your nervous system is grateful.";
            break;
          case "happy":
            msg = "Bright & warm";
            sub = "Let yourself enjoy this without waiting for the other shoe to drop.";
            break;
          case "peace":
            msg = "Tiny pocket of peace";
            sub = "Even a few quiet breaths count as real rest.";
            break;
          case "ease":
            msg = "Moving with ease";
            sub = "Momentum plus kindness to yourself is powerful magic.";
            break;
          default:
            msg = "Gently okay";
            sub = "You‚Äôre doing more than enough.";
        }

        state.mood.labelMain = msg;
        state.mood.labelSub = sub;
        state.mood.tone = tone;

        feelingMessage.textContent = sub;

        // Adjust some needs based on feeling (very lightly)
        if (feelingKey === "hungry") {
          adjustNeed("hunger", -5, false);
        }
        if (["stressed", "overwhelmed", "low", "sad", "angry"].includes(feelingKey)) {
          adjustNeed("energy", -5, false);
          adjustNeed("quiet", -5, false);
        }
        if (["good", "happy", "peace", "ease"].includes(feelingKey)) {
          adjustNeed("fun", +5, false);
        }

        // Sounds
        if (category === "good") playSound("feel-good");
        else if (category === "neutral") playSound("feel-neutral");
        else playSound("feel-low");

        renderStats();
        renderNeeds();
        renderMood();
        saveState();
      }

      function renderStats() {
        statQuests.textContent = state.stats.questsCompleted || 0;
        statWins.textContent = state.stats.daysWin || 0;
        statSelfCare.textContent = state.stats.selfCareBonuses || 0;
        statFeelings.textContent = state.stats.feelingsCheckins || 0;

        const points = (state.stats.questsCompleted || 0)
                     + (state.stats.selfCareBonuses || 0) * 2
                     + (state.stats.daysWin || 0) * 1.5;
        const levelIndex = Math.min(levelNames.length - 1, Math.floor(points / 10));
        levelNameEl.textContent = levelNames[levelIndex];
        // Fill within this band of 10 points
        const bandStart = levelIndex * 10;
        const bandProgress = clamp((points - bandStart) / 10, 0, 1);
        const fillPercent = ((levelIndex) / (levelNames.length - 1)) * 70 + bandProgress * 30;
        levelFill.style.width = `${clamp(fillPercent, 5, 100)}%`;

        hudSubtext.textContent = levelNames[levelIndex];
      }

      function adjustNeed(needId, delta, shouldSave = true) {
        const current = state.needs[needId] ?? 60;
        const next = clamp(current + delta, 0, 100);
        state.needs[needId] = next;
        renderNeeds();
        renderMood();
        if (shouldSave) saveState();
      }

      function renderNeeds() {
        document.querySelectorAll(".need-row").forEach(row => {
          const needId = row.getAttribute("data-need-id");
          const value = state.needs[needId] ?? 60;
          const fill = row.querySelector("[data-need-fill]");
          const label = row.querySelector("[data-need-value]");
          if (fill) fill.style.width = `${value}%`;
          if (label) label.textContent = value;
        });

        // Update HUD dots based on average needs
        const vals = Object.values(state.needs);
        const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
        const dotsOn =
          avg >= 75 ? 3 :
          avg >= 45 ? 2 :
          avg >= 20 ? 1 : 0;

        [dot1, dot2, dot3].forEach((dot, i) => {
          if (!dot) return;
          dot.classList.toggle("on", i < dotsOn);
        });
      }

      function renderMood() {
        const score = state.mood.score ?? 60;
        const tone = state.mood.tone || "neutral";

        moodLabelMain.textContent = state.mood.labelMain || "Gently okay";
        moodLabelSub.textContent = state.mood.labelSub || "You‚Äôre doing more than enough.";

        moodGaugeFill.style.width = `${clamp(score, 5, 100)}%`;

        plumbob.classList.remove("low", "neutral", "good");
        if (score < 35) {
          plumbob.classList.add("low");
        } else if (score < 70) {
          plumbob.classList.add("neutral");
        } else {
          plumbob.classList.add("good");
        }

        if (tone === "good" && score < 60) state.mood.score = 60;
      }

      function updateWinFlagForToday() {
        const completed = state.today.completedTaskIds;
        const isWin = completed.length > 0 || state.today.badDay;
        const key = state.todayDate;
        const previous = !!state.winsByDate[key];
        state.winsByDate[key] = isWin;
        if (isWin && !previous) {
          state.stats.daysWin += 1;
        } else if (!isWin && previous) {
          state.stats.daysWin = Math.max(0, state.stats.daysWin - 1);
        }
      }

      function renderCalendar() {
        const now = new Date(state.todayDate + "T00:00:00");
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-based
        const first = new Date(year, month, 1);
        const firstDay = first.getDay(); // 0 = Sun
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        calendarGrid.innerHTML = "";
        const monthName = now.toLocaleDateString(undefined, { month: "long", year: "numeric" });
        calendarMonthLabel.textContent = monthName;

        // Leading empty slots
        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement("div");
          calendarGrid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const div = document.createElement("div");
          div.className = "calendar-day";
          div.textContent = day;
          if (state.winsByDate[dateStr]) {
            div.classList.add("win");
          }
          if (dateStr === state.todayDate) {
            div.classList.add("today");
          }
          calendarGrid.appendChild(div);
        }
      }

      function renderJournals() {
        const dKey = state.todayDate;
        const mKey = getMonthKey(state.todayDate);
        const yKey = getYearKey(state.todayDate);

        journalDay.value = state.journals.day[dKey] || "";
        journalMonth.value = state.journals.month[mKey] || "";
        journalYear.value = state.journals.year[yKey] || "";
      }

      function startTimersTick() {
        if (timersInterval) clearInterval(timersInterval);
        timersInterval = setInterval(() => {
          tickTimers();
          renderTimers();
        }, 1000);
        renderTimers();
      }

      function tickTimers() {
        const now = Date.now();
        let changed = false;
        for (const id in state.timers) {
          const t = state.timers[id];
          if (!t.isRunning || !t.lastStart) continue;
          const elapsed = now - t.lastStart;
          const remaining = t.remainingMs - elapsed;
          if (remaining <= 0) {
            t.remainingMs = 0;
            t.isRunning = false;
            t.lastStart = null;
            t.completedCount = (t.completedCount || 0) + 1;
            // Self-care bonus for shower / skincare completion
            if (id === "shower" || id === "skincare") {
              state.stats.selfCareBonuses += 1;
            }
            changed = true;
          } else {
            t.remainingMs = remaining;
            t.lastStart = now;
            changed = true;
          }
        }
        if (changed) {
          renderStats();
          saveState();
        }
      }

      function renderTimers() {
        document.querySelectorAll(".timer-row").forEach(row => {
          const id = row.getAttribute("data-timer-id");
          const statusEl = row.querySelector("[data-timer-status]");
          const timer = state.timers[id];
          if (!timer) return;

          let label = "Off";
          let due = false;
          if (timer.isRunning && timer.remainingMs > 0) {
            const minutes = Math.floor(timer.remainingMs / 60000);
            const seconds = Math.floor((timer.remainingMs % 60000) / 1000);
            label = `${minutes}m ${String(seconds).padStart(2, "0")}s`;
          } else if (!timer.isRunning && timer.remainingMs > 0) {
            const minutes = Math.ceil(timer.remainingMs / 60000);
            label = `${minutes}m left`;
          } else if (!timer.isRunning && timer.remainingMs === 0 && timer.completedCount > 0) {
            label = "Due";
            due = true;
          }

          statusEl.textContent = label;
          statusEl.classList.toggle("due", due);
        });
      }

      function startTimer(id) {
        const t = state.timers[id];
        if (!t) return;
        // If it's off, reset duration; if paused, keep remaining
        if (t.remainingMs <= 0) {
          t.remainingMs = (t.durationMinutes || defaultTimersConfig[id].minutes) * 60000;
        }
        t.isRunning = true;
        t.lastStart = Date.now();
        saveState();
        renderTimers();
      }

      function stopTimer(id) {
        const t = state.timers[id];
        if (!t) return;
        t.isRunning = false;
        t.lastStart = null;
        saveState();
        renderTimers();
      }

      function clamp(val, min, max) {
        return Math.max(min, Math.min(max, val));
      }

      // PWA service worker registration
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(() => {});
      }
    })();
  </script>
</body>
</html>
