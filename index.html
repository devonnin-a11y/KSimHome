<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KSim Home ‚Äì Kelly HUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#17313a" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      /* Sims 4 teal + Animal Crossing cozy woods/greens */
      --bg: #f6f3ea;
      --bg-soft: #fbf7ef;
      --bg-card: #ffffff;
      --bg-wood: #e2c7a3;
      --border-soft: #e0d3c2;
      --accent: #00b2c8;
      --accent-soft: #7edbe4;
      --accent-deep: #007289;
      --leaf: #5da66a;
      --leaf-soft: #b7dfb8;
      --text-main: #2b231c;
      --text-soft: #7a685a;
      --danger: #c4475e;
      --good: #4aa866;
      --neutral: #f6c15b;
      --low: #e45b5b;
      --hud-bg: #15252c;
      --hud-soft: #1e333c;
      --hud-outline: #c2f5ff;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.08);
      --shadow-hud: 0 18px 45px rgba(0,0,0,0.42);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top, #ffffff 0, #f3efe4 45%, #e3d5c0 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 128px; /* space for fixed Sims-style HUD */
    }

    body.simple-mode [data-simple-hide="true"] {
      display: none !important;
    }

    .app-shell {
      max-width: 520px;
      margin: 0 auto;
      padding: 10px 12px 20px;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background:
        linear-gradient(135deg, rgba(0,178,200,0.12), rgba(93,166,106,0.15));
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 0 8px 16px rgba(0,0,0,0.08);
      backdrop-filter: blur(8px);
      margin-bottom: 10px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-logo {
      width: 30px;
      height: 30px;
      border-radius: 40% 60% 42% 58%;
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #17313a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f7fbff;
      font-weight: 700;
      font-size: 18px;
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.9),
        0 6px 12px rgba(0,0,0,0.2);
    }

    .top-text-main {
      font-weight: 700;
      letter-spacing: 0.04em;
      font-size: 15px;
    }

    .top-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.07);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chip-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, var(--accent));
      box-shadow: 0 0 6px rgba(0,178,200,0.9);
    }

    .btn-pill {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(23,49,58,0.06);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
    }

    .btn-pill span.icon {
      font-size: 14px;
    }

    .btn-pill:active {
      transform: scale(0.97);
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      margin: 8px 0 12px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      padding: 3px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.9);
    }

    .tab-button {
      flex: 1;
      border-radius: 14px;
      border: none;
      background: transparent;
      padding: 8px 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
    }

    .tab-button-icon {
      font-size: 15px;
    }

    .tab-button.active {
      background: linear-gradient(135deg, var(--accent), var(--leaf));
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-icon {
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .badge-soft {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.02);
      padding: 2px 7px;
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Quests */
    .quest-list {
      list-style: none;
      margin: 2px 0 6px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quest-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 8px;
      border-radius: var(--radius-md);
      background: var(--bg-soft);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .quest-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .quest-text {
      font-size: 13px;
      flex: 1;
    }

    .quest-item.completed {
      opacity: 0.8;
    }

    .quest-item.completed .quest-text {
      text-decoration: line-through;
      color: var(--text-soft);
    }

    .btn-soft {
      appearance: none;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #f6d1dc, #e199ac);
      color: #3b1221;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .btn-soft span.icon {
      font-size: 14px;
    }

    .btn-soft.bad-day-active {
      background: linear-gradient(135deg, #c4e2ff, #9fbfff);
      color: #10243f;
    }

    .muted-text {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* Quick need actions */
    .need-actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-soft-alt {
      flex: 1 0 calc(50% - 4px);
      justify-content: center;
      white-space: nowrap;
    }

    /* Feelings */
    .feelings-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .feeling-btn {
      flex: 1 0 calc(33.33% - 4px);
      border: none;
      border-radius: 999px;
      font-size: 11px;
      padding: 6px 8px;
      cursor: pointer;
      background: #f3eee8;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 0;
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }

    .feeling-btn span.icon {
      font-size: 13px;
    }

    .feeling-btn[data-tone="good"] { background: #e4f5eb; }
    .feeling-btn[data-tone="neutral"] { background: #fef3dc; }
    .feeling-btn[data-tone="low"] { background: #fde7e7; }

    .feeling-message {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    /* Timers */
    .timer-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .timer-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 8px;
      border-radius: var(--radius-md);
      background: #f6f0e7;
    }

    .timer-label-main {
      font-size: 12px;
      font-weight: 500;
    }

    .timer-label-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .timer-status {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      min-width: 68px;
      text-align: center;
    }

    .timer-status.due {
      background: rgba(228,91,91,0.12);
      color: var(--low);
    }

    .timer-cta {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }

    .btn-timer {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
    }

    .btn-timer.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
    }

    /* Stats & Needs */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .stat-pill {
      flex: 1 0 calc(50% - 4px);
      border-radius: var(--radius-md);
      padding: 6px 7px;
      background: #f5efe8;
      font-size: 11px;
    }

    .stat-pill-label {
      color: var(--text-soft);
      font-size: 10px;
    }

    .stat-pill-value {
      font-weight: 600;
      margin-top: 2px;
    }

    .level-bar-wrap {
      margin-top: 8px;
    }

    .level-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .level-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .level-bar {
      width: 100%;
      height: 8px;
      background: rgba(0,0,0,0.06);
      border-radius: 999px;
      overflow: hidden;
    }

    .level-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--leaf-soft), var(--leaf));
      transition: width 0.25s ease;
    }

    .needs-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .need-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) 2fr auto;
      gap: 8px;
      align-items: center;
    }

    .need-label {
      font-size: 12px;
      font-weight: 500;
    }

    .need-bar-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      overflow: hidden;
      position: relative;
    }

    .need-bar-fill {
      height: 100%;
      width: 50%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.25s ease;
    }

    .need-bar-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 3px rgba(0,0,0,0.25);
      pointer-events: none;
    }

    .need-controls {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-need {
      border-radius: 999px;
      border: none;
      padding: 2px 7px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
    }

    .need-value {
      font-size: 11px;
      color: var(--text-soft);
      min-width: 32px;
      text-align: right;
    }

    /* Journals & calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 6px;
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 9px;
      color: var(--text-soft);
      text-align: center;
      margin-top: 4px;
    }

    .calendar-day {
      font-size: 11px;
      padding: 4px 0;
      border-radius: 999px;
      text-align: center;
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.04);
      position: relative;
    }

    .calendar-day.win::after {
      content: "‚òÖ";
      position: absolute;
      top: 1px;
      right: 4px;
      font-size: 9px;
      color: var(--accent);
    }

    .calendar-day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,178,200,0.6);
      font-weight: 600;
    }

    .calendar-month-label {
      font-size: 12px;
      font-weight: 600;
    }

    .journal-group {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .journal-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .journal-textarea {
      width: 100%;
      min-height: 68px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #fbf6ee;
      padding: 8px;
      font-size: 12px;
      resize: vertical;
      font-family: inherit;
    }

    /* Sims-style HUD & moodlets ‚Äì fixed bottom */
    .hud-shell {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 6px 8px 8px;
      z-index: 40;
      pointer-events: none;
    }

    .hud-inner-wrap {
      max-width: 520px;
      margin: 0 auto;
      pointer-events: auto;
    }

    .hud-moodlets {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
      justify-content: flex-start;
      padding-left: 10px;
    }

    .moodlet-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 10px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      /* moodlet life animation: fade in, stay, fade left */
      animation: moodlet-life 7s ease-in-out forwards;
    }

    .moodlet-chip[data-tone="good"] {
      background: #ecf9f0;
      border-color: #8fd0a0;
    }
    .moodlet-chip[data-tone="neutral"] {
      background: #fff6e6;
      border-color: #f0cd8c;
    }
    .moodlet-chip[data-tone="low"] {
      background: #fde6e7;
      border-color: #f1979d;
    }

    .moodlet-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #ffffff;
    }

    .hud-inner {
      background:
        radial-gradient(circle at top, #325c6a 0, #17313a 55%, #0a1417 100%);
      border-radius: 20px 20px 10px 10px;
      border: 1px solid #2d414b;
      box-shadow: var(--shadow-hud);
      padding: 8px 10px 6px;
      display: grid;
      grid-template-columns: auto 1.3fr auto;
      gap: 8px;
      align-items: center;
      position: relative;
    }

    .hud-inner::before {
      content: "";
      position: absolute;
      inset: 1px 1px auto;
      border-radius: 18px 18px 8px 8px;
      border-top: 1px solid rgba(255,255,255,0.12);
      pointer-events: none;
    }

    .hud-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .portrait-frame {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 25% 20%, #fdf7ef, #4b2d1d);
      border: 2px solid var(--hud-outline);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fdf9f2;
      font-size: 23px;
      font-weight: 700;
      box-shadow:
        0 0 0 2px rgba(0,0,0,0.6),
        0 0 12px rgba(165,232,255,0.8);
    }

    .portrait-meta {
      font-size: 11px;
      color: #e7f7ff;
    }

    .portrait-meta-name {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 11px;
    }

    .portrait-meta-sub {
      font-size: 10px;
      color: #bdd5df;
    }

    .hud-center {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .plumbob-wrap {
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .plumbob {
      width: 18px;
      height: 26px;
      position: relative;
      transform: translateY(0);
    }

    .plumbob-shape {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, #4df18d, #178348);
      clip-path: polygon(50% 0, 100% 50%, 50% 100%, 0 50%);
      box-shadow: 0 0 10px rgba(154,255,180,0.9);
    }

    .plumbob.low {
      filter: hue-rotate(-35deg) brightness(0.85);
    }
    .plumbob.neutral {
      filter: hue-rotate(40deg);
    }
    .plumbob.good {
      filter: hue-rotate(75deg) saturate(1.1);
    }

    .mood-label-main {
      font-size: 12px;
      font-weight: 600;
      color: #f6fbff;
    }

    .mood-label-sub {
      font-size: 11px;
      color: #bfd7e0;
    }

    .mood-gauge-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      overflow: hidden;
      position: relative;
    }

    .mood-gauge-fill {
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.25s ease;
    }

    .mood-gauge-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.7);
    }

    .hud-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .dot-row {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.24);
    }

    .dot.on {
      background: #e7f6ff;
      box-shadow: 0 0 5px rgba(202,246,255,0.9);
    }

    .dot-label {
      font-size: 10px;
      color: #c8dde6;
      margin-right: 4px;
    }

    .hud-hint {
      font-size: 9px;
      color: #8ea6b2;
    }

    .btn-music {
      border: none;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 9px;
      background: rgba(0,0,0,0.4);
      color: #e7f7ff;
      cursor: pointer;
    }

    @keyframes moodlet-life {
      0% {
        opacity: 0;
        transform: translateX(10px);
      }
      10% {
        opacity: 1;
        transform: translateX(0);
      }
      80% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(-14px);
      }
    }

    @media (min-width: 640px) {
      body {
        padding-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- TOP BAR -->
    <header class="top-bar">
      <div class="top-left">
        <div class="top-logo">K</div>
        <div>
          <div class="top-text-main">KSim Home</div>
          <div class="top-text-sub">Kelly‚Äôs cozy Sims √ó Crossing day</div>
        </div>
      </div>
      <div class="top-right">
        <div class="chip" id="dayChip">
          <span class="chip-dot"></span>
          <span>Today</span>
        </div>
        <button class="btn-pill" id="simpleToggle" type="button">
          <span class="icon">üçÉ</span>
          <span>Simple view</span>
        </button>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tab-bar">
      <button class="tab-button active" data-tab-target="dashboard" type="button">
        <span class="tab-button-icon">üè†</span>
        <span>Dashboard</span>
      </button>
      <button class="tab-button" data-tab-target="needs" type="button">
        <span class="tab-button-icon">üíö</span>
        <span>Needs &amp; Stats</span>
      </button>
      <button class="tab-button" data-tab-target="journals" type="button">
        <span class="tab-button-icon">üìì</span>
        <span>Journals</span>
      </button>
    </nav>

    <main>
      <!-- DASHBOARD TAB -->
      <section class="tab-panel active" data-tab="dashboard">
        <!-- Quests -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">‚ú®</span>
              <span>Today‚Äôs tiny quests</span>
            </div>
            <span class="badge-soft" id="questsSummary">0 / 2 done</span>
          </div>
          <p class="card-subtitle">
            Just two little things. If life explodes and you only tap ‚ÄúRough day‚Äù, it still counts as a win.
          </p>
          <ul class="quest-list" id="questList"></ul>
          <button class="btn-soft" id="badDayButton" type="button">
            <span class="icon">üíó</span>
            <span>Had a rough day?</span>
          </button>
          <div class="muted-text" id="badDayMessage">
            For the days that were just too much. You surviving them is a win.
          </div>
        </section>

        <!-- Quick need actions (Snack / Meal / Bathroom / Shower) -->
        <section class="card" id="needActionsCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üçΩÔ∏è</span>
              <span>Quick Sim actions</span>
            </div>
          </div>
          <p class="card-subtitle">
            Tap what you actually did ‚Äî the bars and mood will adjust like in-game.
          </p>
          <div class="need-actions-row">
            <button class="btn-soft btn-soft-alt" data-need-action="snack" type="button">
              <span class="icon">üçé</span><span>Snack</span>
            </button>
            <button class="btn-soft btn-soft-alt" data-need-action="meal" type="button">
              <span class="icon">üç≤</span><span>Meal</span>
            </button>
            <button class="btn-soft btn-soft-alt" data-need-action="bathroom" type="button" data-simple-hide="true">
              <span class="icon">üöΩ</span><span>Bathroom break</span>
            </button>
            <button class="btn-soft btn-soft-alt" data-need-action="quick-shower" type="button" data-simple-hide="true">
              <span class="icon">üöø</span><span>Quick shower</span>
            </button>
          </div>
        </section>

        <!-- Feelings -->
        <section class="card" id="feelingsCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üß†</span>
              <span>How does Kelly feel?</span>
            </div>
          </div>
          <p class="card-subtitle">
            Your feelings are information, not a report card. Tap whatever is closest.
          </p>
          <div class="feelings-strip">
            <!-- low -->
            <button class="feeling-btn" data-feeling="stressed" data-tone="low" data-category="low" type="button">
              <span class="icon">‚ö°</span><span>Stressed</span>
            </button>
            <button class="feeling-btn" data-feeling="overwhelmed" data-tone="low" data-category="low" type="button">
              <span class="icon">üåä</span><span>Overwhelmed</span>
            </button>
            <button class="feeling-btn" data-feeling="low" data-tone="low" data-category="low" type="button">
              <span class="icon">üåßÔ∏è</span><span>Low</span>
            </button>
            <button class="feeling-btn" data-feeling="sad" data-tone="low" data-category="low" type="button">
              <span class="icon">üíß</span><span>Sad</span>
            </button>
            <button class="feeling-btn" data-feeling="angry" data-tone="low" data-category="low" type="button">
              <span class="icon">üî•</span><span>Angry</span>
            </button>
            <button class="feeling-btn" data-feeling="hungry" data-tone="neutral" data-category="neutral" type="button">
              <span class="icon">üçû</span><span>Hungry</span>
            </button>
            <!-- neutral/good -->
            <button class="feeling-btn" data-feeling="good" data-tone="good" data-category="good" type="button">
              <span class="icon">üôÇ</span><span>Good</span>
            </button>
            <button class="feeling-btn" data-feeling="happy" data-tone="good" data-category="good" type="button">
              <span class="icon">üòä</span><span>Happy</span>
            </button>
            <button class="feeling-btn" data-feeling="peace" data-tone="good" data-category="good" type="button">
              <span class="icon">üïäÔ∏è</span><span>Peace</span>
            </button>
            <button class="feeling-btn" data-feeling="ease" data-tone="good" data-category="good" type="button">
              <span class="icon">üåø</span><span>Ease</span>
            </button>
          </div>
          <div class="feeling-message" id="feelingMessage">
            Whatever you tapped is allowed to exist without being fixed right away.
          </div>
        </section>

        <!-- Timers -->
        <section class="card" id="timersCard">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">‚è±Ô∏è</span>
              <span>Soft check-in timers</span>
            </div>
          </div>
          <p class="card-subtitle">
            These are gentle nudges, not alarms. It‚Äôs okay if you ignore them.
          </p>
          <div class="timer-list">
            <div class="timer-row" data-timer-id="hydration">
              <div>
                <div class="timer-label-main">Hydration</div>
                <div class="timer-label-sub">Sip water or tea</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="meal">
              <div>
                <div class="timer-label-main">Meal</div>
                <div class="timer-label-sub">Real food for you</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="snack">
              <div>
                <div class="timer-label-main">Snack</div>
                <div class="timer-label-sub">Tiny fuel boost</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="bathroom">
              <div>
                <div class="timer-label-main">Bathroom break</div>
                <div class="timer-label-sub">Your body matters too</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="shower" data-simple-hide="true">
              <div>
                <div class="timer-label-main">Hot shower</div>
                <div class="timer-label-sub">Steam, breathe, reset</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
            <div class="timer-row" data-timer-id="skincare" data-simple-hide="true">
              <div>
                <div class="timer-label-main">Skincare</div>
                <div class="timer-label-sub">Tiny goddess ritual</div>
              </div>
              <div class="timer-status" data-timer-status>Off</div>
              <div class="timer-cta">
                <button class="btn-timer primary" data-timer-action="start" type="button">Start</button>
                <button class="btn-timer" data-timer-action="stop" type="button">Pause</button>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- NEEDS & STATS TAB -->
      <section class="tab-panel" data-tab="needs">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üõ°Ô∏è</span>
              <span>Solopa Viking stats</span>
            </div>
          </div>
          <p class="card-subtitle">
            These level up slowly, like a favorite save file. Tiny actions still count.
          </p>
          <div class="stats-row">
            <div class="stat-pill">
              <div class="stat-pill-label">Quests completed</div>
              <div class="stat-pill-value" id="statQuests">0</div>
            </div>
            <div class="stat-pill">
              <div class="stat-pill-label">Days counted as wins</div>
              <div class="stat-pill-value" id="statWins">0</div>
            </div>
            <div class="stat-pill" data-simple-hide="true">
              <div class="stat-pill-label">Self-care bonuses</div>
              <div class="stat-pill-value" id="statSelfCare">0</div>
            </div>
            <div class="stat-pill" data-simple-hide="true">
              <div class="stat-pill-label">Feelings check-ins</div>
              <div class="stat-pill-value" id="statFeelings">0</div>
            </div>
          </div>
          <div class="level-bar-wrap">
            <div class="level-label">Solopa Viking level</div>
            <div class="level-name" id="levelName">Hearth Seedling</div>
            <div class="level-bar">
              <div class="level-fill" id="levelFill"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üíö</span>
              <span>Needs board</span>
            </div>
          </div>
          <p class="card-subtitle">
            Treat these like Animal Crossing hearts & bells ‚Äî a soft guide, not a demand.
          </p>
          <div class="needs-list">
            <div class="need-row" data-need-id="hunger">
              <div class="need-label">Hunger</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="energy">
              <div class="need-label">Energy</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="social">
              <div class="need-label">Social</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="fun">
              <div class="need-label">Fun</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="hygiene" data-simple-hide="true">
              <div class="need-label">Hygiene</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
            <div class="need-row" data-need-id="quiet" data-simple-hide="true">
              <div class="need-label">Quiet / Alone</div>
              <div class="need-bar-shell">
                <div class="need-bar-fill" data-need-fill></div>
              </div>
              <div class="need-controls">
                <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                <span class="need-value" data-need-value>60</span>
                <button class="btn-need" data-need-delta="10" type="button">+</button>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- JOURNALS TAB -->
      <section class="tab-panel" data-tab="journals">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üóìÔ∏è</span>
              <span>Win-the-day calendar</span>
            </div>
            <span class="calendar-month-label" id="calendarMonthLabel"></span>
          </div>
          <p class="card-subtitle">
            Any quest done or ‚ÄúRough day‚Äù tapped makes this day a win on your map.
          </p>
          <div class="calendar-header">
            <div>Sun</div><div>Mon</div><div>Tue</div>
            <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </section>

        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="card-title-icon">üìñ</span>
              <span>Journals</span>
            </div>
          </div>
          <div class="journal-group">
            <div>
              <div class="journal-label">Today‚Äôs little log</div>
              <textarea class="journal-textarea" id="journalDay" placeholder="A few lines about today is plenty."></textarea>
            </div>
            <div data-simple-hide="true">
              <div class="journal-label">This month‚Äôs story</div>
              <textarea class="journal-textarea" id="journalMonth" placeholder="What this month feels like overall‚Ä¶"></textarea>
            </div>
            <div data-simple-hide="true">
              <div class="journal-label">This year‚Äôs chapter</div>
              <textarea class="journal-textarea" id="journalYear" placeholder="Big picture thoughts that future you might smile at."></textarea>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- HUD + moodlets (always visible at bottom like Sims 4) -->
  <div class="hud-shell">
    <div class="hud-inner-wrap">
      <div class="hud-moodlets" id="moodletBar">
        <!-- moodlet chips injected here -->
      </div>
      <div class="hud-inner">
        <div class="hud-left">
          <div class="portrait-frame">K</div>
          <div class="portrait-meta">
            <div class="portrait-meta-name">Kelly</div>
            <div class="portrait-meta-sub" id="hudSubtext">Solopa Hearthling</div>
          </div>
        </div>
        <div class="hud-center">
          <div class="plumbob-wrap">
            <div class="plumbob" id="plumbob">
              <div class="plumbob-shape"></div>
            </div>
            <div>
              <div class="mood-label-main" id="moodLabelMain">Gently okay</div>
              <div class="mood-label-sub" id="moodLabelSub">You‚Äôre doing more than enough.</div>
            </div>
          </div>
          <div class="mood-gauge-shell">
            <div class="mood-gauge-fill" id="moodGaugeFill"></div>
          </div>
        </div>
        <div class="hud-right">
          <button class="btn-music" id="musicToggle" type="button">Music: Off</button>
          <div class="dot-row">
            <span class="dot-label">Needs</span>
            <span class="dot" id="dot1"></span>
            <span class="dot" id="dot2"></span>
            <span class="dot" id="dot3"></span>
          </div>
          <div class="hud-hint">Nothing here can fail. It just notices.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUDIO -->
  <audio data-sound="ui-click" src="sounds/ui-click.mp3" preload="auto"></audio>
  <audio data-sound="feel-good" src="sounds/feel-good.mp3" preload="auto"></audio>
  <audio data-sound="feel-neutral" src="sounds/feel-neutral.mp3" preload="auto"></audio>
  <audio data-sound="feel-low" src="sounds/feel-low.mp3" preload="auto"></audio>
  <!-- low background music -->
  <audio data-sound="bg-music" src="sounds/bg-music.mp3" preload="auto" loop></audio>

  <script>
    (function () {
      const STORAGE_KEY = "ksimHomeState_v3";

      const defaultTimersConfig = {
        hydration: { minutes: 60 },
        meal: { minutes: 180 },
        snack: { minutes: 120 },
        bathroom: { minutes: 90 },
        shower: { minutes: 30 },
        skincare: { minutes: 45 }
      };

      // Needs decay per minute (Sims-ish)
      const needsDecayPerMinute = {
        hunger: 0.6,  // ~100 -> 0 in ~2.7h
        energy: 0.4,  // ~4h
        social: 0.25, // ~6.5h
        fun: 0.25,
        hygiene: 0.2,
        quiet: 0.2
      };

      const tasksPool = [
        "Clear and wipe the kitchen counters",
        "Sweep the living room floor",
        "Fold one mini-load of laundry",
        "Tidy toys from one room",
        "Reset the bathroom sink area",
        "Wipe the dining table",
        "Quick vacuum of main hallway",
        "Put away clean dishes / run dishwasher",
        "Declutter one small surface",
        "Start or switch one load of laundry"
      ];

      const levelNames = [
        "Hearth Seedling",
        "Cozy Sprout",
        "Ember Keeper",
        "Hearth Guardian",
        "Solopa Shield-Maiden",
        "Homestead High Priestess"
      ];

      function todayDateString() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function getMonthKey(dateStr) {
        return dateStr.slice(0, 7);
      }

      function getYearKey(dateStr) {
        return dateStr.slice(0, 4);
      }

      function initTimersState() {
        const base = {};
        for (const id in defaultTimersConfig) {
          base[id] = {
            durationMinutes: defaultTimersConfig[id].minutes,
            remainingMs: 0,
            isRunning: false,
            lastStart: null,
            completedCount: 0
          };
        }
        return base;
      }

      function createFreshState() {
        const now = Date.now();
        const today = todayDateString();
        return {
          version: 3,
          todayDate: today,
          today: {
            tasks: [],
            completedTaskIds: [],
            badDay: false
          },
          winsByDate: {},
          needs: {
            hunger: 60,
            energy: 60,
            social: 60,
            fun: 60,
            hygiene: 60,
            quiet: 60
          },
          lastNeedsUpdate: now,
          stats: {
            questsCompleted: 0,
            daysWin: 0,
            selfCareBonuses: 0,
            feelingsCheckins: 0
          },
          mood: {
            score: 60,
            tier: "neutral",
            labelMain: "Gently okay",
            labelSub: "You‚Äôre doing more than enough.",
            lastTier: "neutral",
            lastFeelingTone: "neutral"
          },
          timers: initTimersState(),
          journals: {
            day: {},
            month: {},
            year: {}
          },
          moodlets: [] // {id, label, tone}
        };
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return createFreshState();
        try {
          const parsed = JSON.parse(raw);
          return migrateState(parsed);
        } catch {
          return createFreshState();
        }
      }

      function migrateState(state) {
        if (!state.version) state.version = 3;
        if (!state.timers) state.timers = initTimersState();
        if (!state.journals) state.journals = { day: {}, month: {}, year: {} };
        if (!state.mood) {
          state.mood = {
            score: 60,
            tier: "neutral",
            labelMain: "Gently okay",
            labelSub: "You‚Äôre doing more than enough.",
            lastTier: "neutral",
            lastFeelingTone: "neutral"
          };
        }
        if (!Array.isArray(state.moodlets)) state.moodlets = [];
        if (!state.needs) {
          state.needs = {
            hunger: 60,
            energy: 60,
            social: 60,
            fun: 60,
            hygiene: 60,
            quiet: 60
          };
        }
        if (!state.lastNeedsUpdate) {
          state.lastNeedsUpdate = Date.now();
        }
        return state;
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function ensureToday() {
        const todayStr = todayDateString();
        if (state.todayDate === todayStr && state.today.tasks && state.today.tasks.length) {
          return;
        }
        state.todayDate = todayStr;
        state.today = {
          tasks: pickTodayTasks(todayStr),
          completedTaskIds: [],
          badDay: false
        };
      }

      function pickTodayTasks(dateStr) {
        const d = new Date(dateStr + "T00:00:00");
        const seed = d.getDate() + (d.getMonth() + 1) * 13;
        const index1 = seed % tasksPool.length;
        const index2 = (seed * 5 + 3) % tasksPool.length;
        const ids = [index1, index2 === index1 ? (index2 + 1) % tasksPool.length : index2];
        return ids.map(id => ({ id, text: tasksPool[id] }));
      }

      function playSound(name) {
        const audio = document.querySelector(`audio[data-sound="${name}"]`);
        if (!audio) return;
        try {
          audio.currentTime = 0;
          audio.play().catch(() => {});
        } catch {}
      }

      function uiClick() {
        playSound("ui-click");
      }

      // --- State & DOM refs ---
      let state = loadState();
      ensureToday();

      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const dayChip = document.getElementById("dayChip");
      const simpleToggle = document.getElementById("simpleToggle");

      const questList = document.getElementById("questList");
      const questsSummary = document.getElementById("questsSummary");
      const badDayButton = document.getElementById("badDayButton");
      const badDayMessage = document.getElementById("badDayMessage");
      const feelingMessage = document.getElementById("feelingMessage");

      const statQuests = document.getElementById("statQuests");
      const statWins = document.getElementById("statWins");
      const statSelfCare = document.getElementById("statSelfCare");
      const statFeelings = document.getElementById("statFeelings");
      const levelNameEl = document.getElementById("levelName");
      const levelFill = document.getElementById("levelFill");

      const calendarMonthLabel = document.getElementById("calendarMonthLabel");
      const calendarGrid = document.getElementById("calendarGrid");

      const journalDay = document.getElementById("journalDay");
      const journalMonth = document.getElementById("journalMonth");
      const journalYear = document.getElementById("journalYear");

      const plumbob = document.getElementById("plumbob");
      const moodLabelMain = document.getElementById("moodLabelMain");
      const moodLabelSub = document.getElementById("moodLabelSub");
      const moodGaugeFill = document.getElementById("moodGaugeFill");
      const hudSubtext = document.getElementById("hudSubtext");
      const dot1 = document.getElementById("dot1");
      const dot2 = document.getElementById("dot2");
      const dot3 = document.getElementById("dot3");
      const moodletBar = document.getElementById("moodletBar");

      const needActionsCard = document.getElementById("needActionsCard");

      const musicToggle = document.getElementById("musicToggle");
      const musicAudio = document.querySelector('audio[data-sound="bg-music"]');
      let musicOn = false;

      let timersInterval = null;

      // --- Initial render sequence (with needs decayed by real time) ---
      updateNeedsOverTime(true);
      renderDayChip();
      renderQuests();
      renderBadDay();
      recomputeMoodFromNeeds();
      renderStats();
      renderNeeds();
      renderMood(false);
      renderCalendar();
      renderJournals();
      renderMoodlets();
      startTimersTick();

      // --- Global click sound ---
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (btn) uiClick();
      });

      // Tabs
      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab-target");
          tabButtons.forEach(b => b.classList.toggle("active", b === btn));
          tabPanels.forEach(p => p.classList.toggle("active", p.getAttribute("data-tab") === target));
        });
      });

      // Simple view
      simpleToggle.addEventListener("click", () => {
        document.body.classList.toggle("simple-mode");
      });

      // Music toggle
      if (musicToggle) {
        musicToggle.addEventListener("click", () => {
          if (!musicAudio) return;
          if (musicOn) {
            musicAudio.pause();
            musicOn = false;
            musicToggle.textContent = "Music: Off";
          } else {
            musicAudio.loop = true;
            musicAudio.play().catch(() => {});
            musicOn = true;
            musicToggle.textContent = "Music: On";
          }
        });
      }

      // Quests
      questList.addEventListener("change", (e) => {
        if (e.target.matches('input[type="checkbox"][data-quest-id]')) {
          const questId = parseInt(e.target.getAttribute("data-quest-id"), 10);
          const completed = state.today.completedTaskIds;
          const already = completed.includes(questId);
          if (e.target.checked && !already) {
            completed.push(questId);
            state.stats.questsCompleted += 1;
          } else if (!e.target.checked && already) {
            const idx = completed.indexOf(questId);
            if (idx >= 0) completed.splice(idx, 1);
            state.stats.questsCompleted = Math.max(0, state.stats.questsCompleted - 1);
          }
          updateWinFlagForToday();
          renderQuests();
          renderStats();
          renderCalendar();
          saveState();
        }
      });

      // Bad day button
      badDayButton.addEventListener("click", () => {
        state.today.badDay = !state.today.badDay;
        updateWinFlagForToday();
        renderBadDay();
        renderStats();
        renderCalendar();
        saveState();
      });

      // Quick need actions
      needActionsCard.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-need-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-need-action");
        handleNeedAction(action);
      });

      // Feelings
      document.getElementById("feelingsCard").addEventListener("click", (e) => {
        const btn = e.target.closest(".feeling-btn");
        if (!btn) return;
        const category = btn.getAttribute("data-category");
        const tone = btn.getAttribute("data-tone");
        const feelingKey = btn.getAttribute("data-feeling");
        handleFeeling(feelingKey, category, tone);
      });

      // Timers
      document.getElementById("timersCard").addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-timer");
        if (!btn) return;
        const row = btn.closest(".timer-row");
        const timerId = row.getAttribute("data-timer-id");
        const action = btn.getAttribute("data-timer-action");
        if (action === "start") startTimer(timerId);
        if (action === "stop") stopTimer(timerId);
      });

      // Needs +/- buttons
      document.querySelectorAll(".need-row").forEach(row => {
        row.addEventListener("click", (e) => {
          const btn = e.target.closest(".btn-need");
          if (!btn) return;
          const delta = parseInt(btn.getAttribute("data-need-delta"), 10);
          const needId = row.getAttribute("data-need-id");
          adjustNeed(needId, delta);
        });
      });

      // Journals
      journalDay.addEventListener("input", () => {
        const key = state.todayDate;
        state.journals.day[key] = journalDay.value;
        saveState();
      });
      journalMonth.addEventListener("input", () => {
        const key = getMonthKey(state.todayDate);
        state.journals.month[key] = journalMonth.value;
        saveState();
      });
      journalYear.addEventListener("input", () => {
        const key = getYearKey(state.todayDate);
        state.journals.year[key] = journalYear.value;
        saveState();
      });

      // --- Helpers ---

      function renderDayChip() {
        const d = new Date(state.todayDate + "T00:00:00");
        const options = { weekday: "short", month: "short", day: "numeric" };
        const label = d.toLocaleDateString(undefined, options);
        dayChip.querySelector("span:nth-child(2)").textContent = label;
      }

      function renderQuests() {
        ensureToday();
        questList.innerHTML = "";
        state.today.tasks.forEach(t => {
          const li = document.createElement("li");
          li.className = "quest-item";
          if (state.today.completedTaskIds.includes(t.id)) li.classList.add("completed");
          li.innerHTML = `
            <input type="checkbox" data-quest-id="${t.id}" ${state.today.completedTaskIds.includes(t.id) ? "checked" : ""}/>
            <div class="quest-text">${t.text}</div>
          `;
          questList.appendChild(li);
        });
        questsSummary.textContent = `${state.today.completedTaskIds.length} / ${state.today.tasks.length} done`;
      }

      function renderBadDay() {
        if (state.today.badDay) {
          badDayButton.classList.add("bad-day-active");
          badDayButton.innerHTML = `<span class="icon">üíó</span><span>Bad day logged ‚Äî you still win</span>`;
          badDayMessage.textContent = "This day is marked as a win because you lived through it. That‚Äôs enough.";
        } else {
          badDayButton.classList.remove("bad-day-active");
          badDayButton.innerHTML = `<span class="icon">üíó</span><span>Had a rough day?</span>`;
          badDayMessage.textContent = "Tap this for the days that were just too much. The calendar will still count it as a win.";
        }
      }

      function handleNeedAction(action) {
        const n = state.needs;
        let label = "";
        let tone = "good";

        if (action === "snack") {
          n.hunger = clamp(n.hunger + 25, 0, 100);
          n.energy = clamp(n.energy + 25, 0, 100);
          startTimer("snack");
          label = "Snack boost";
          state.stats.selfCareBonuses += 1;
          playSound("feel-good");
        } else if (action === "meal") {
          n.hunger = 100;
          n.energy = clamp(n.energy + 75, 0, 100);
          startTimer("meal");
          label = "Full meal buff";
          state.stats.selfCareBonuses += 1;
          playSound("feel-good");
        } else if (action === "bathroom") {
          // Using toilet: small hygiene drop in a realistic Sims way
          n.hygiene = clamp(n.hygiene - 15, 0, 100);
          startTimer("bathroom");
          label = "Relieved";
          tone = "neutral";
          playSound("feel-neutral");
        } else if (action === "quick-shower") {
          // Quick shower: big hygiene bump
          n.hygiene = clamp(n.hygiene + 60, 0, 100);
          startTimer("shower");
          label = "Quick shower fresh";
          state.stats.selfCareBonuses += 1;
          playSound("feel-good");
        }

        if (label) {
          addMoodlet({
            id: `action-${action}`,
            label,
            tone
          });
        }

        recomputeMoodFromNeeds();
        renderStats();
        renderNeeds();
        renderMood(true);
        renderMoodlets();
        saveState();
      }

      function handleFeeling(feelingKey, category, tone) {
        state.stats.feelingsCheckins += 1;
        state.mood.lastFeelingTone = tone || "neutral";

        let msg = "";
        let sub = "";

        switch (feelingKey) {
          case "stressed":
            msg = "Stressed & still standing";
            sub = "Your brain is juggling a lot. Overload isn‚Äôt a failure; it‚Äôs a signal.";
            break;
          case "overwhelmed":
            msg = "Overwhelmed, not weak";
            sub = "Too much on one person is a village problem, not a you problem.";
            break;
          case "low":
            msg = "Low battery";
            sub = "Low mood is your nervous system asking for gentleness, not proof of being ‚Äòlazy‚Äô.";
            break;
          case "sad":
            msg = "Soft sadness";
            sub = "Tears and heaviness are allowed here. You don‚Äôt have to push them away.";
            break;
          case "angry":
            msg = "Guarding your fire";
            sub = "Anger is your boundary alarm, not proof that you‚Äôre ‚Äòtoo much‚Äô.";
            break;
          case "hungry":
            msg = "Body needs fuel";
            sub = "Feeding yourself is a family buff, not selfish.";
            break;
          case "good":
            msg = "Gently good";
            sub = "Let yourself enjoy the softness of this moment.";
            break;
          case "happy":
            msg = "Bright & warm";
            sub = "Joy is allowed even when everything isn‚Äôt perfect.";
            break;
          case "peace":
            msg = "Tiny pocket of peace";
            sub = "Even a quiet breath on the couch counts as rest.";
            break;
          case "ease":
            msg = "Moving with ease";
            sub = "Ease plus tiny actions is powerful magic.";
            break;
          default:
            msg = "Gently okay";
            sub = "You‚Äôre doing more than enough.";
        }

        feelingMessage.textContent = sub;
        state.mood.labelMain = msg;
        state.mood.labelSub = sub;

        // Light need effects
        if (feelingKey === "hungry") {
          adjustNeed("hunger", -5, false);
        }
        if (["stressed", "overwhelmed", "low", "sad", "angry"].includes(feelingKey)) {
          adjustNeed("energy", -5, false);
          adjustNeed("quiet", -5, false);
        }
        if (["good", "happy", "peace", "ease"].includes(feelingKey)) {
          adjustNeed("fun", +5, false);
        }

        addMoodlet({
          id: `feeling-${feelingKey}`,
          label: msg,
          tone: tone || "neutral"
        });

        // Play sound directly based on feeling tone
        if (tone === "good") playSound("feel-good");
        else if (tone === "low") playSound("feel-low");
        else playSound("feel-neutral");

        recomputeMoodFromNeeds();
        renderStats();
        renderNeeds();
        renderMood(true);  // still plays tier-change sound if tier shifts
        renderMoodlets();
        saveState();
      }

      function renderStats() {
        statQuests.textContent = state.stats.questsCompleted || 0;
        statWins.textContent = state.stats.daysWin || 0;
        statSelfCare.textContent = state.stats.selfCareBonuses || 0;
        statFeelings.textContent = state.stats.feelingsCheckins || 0;

        const points = (state.stats.questsCompleted || 0)
                     + (state.stats.selfCareBonuses || 0) * 2
                     + (state.stats.daysWin || 0) * 1.5;
        const levelIndex = Math.min(levelNames.length - 1, Math.floor(points / 10));
        levelNameEl.textContent = levelNames[levelIndex];
        const bandStart = levelIndex * 10;
        const bandProgress = clamp((points - bandStart) / 10, 0, 1);
        const fillPercent = ((levelIndex) / (levelNames.length - 1)) * 70 + bandProgress * 30;
        levelFill.style.width = `${clamp(fillPercent, 5, 100)}%`;

        hudSubtext.textContent = levelNames[levelIndex];
      }

      function adjustNeed(needId, delta, shouldSave = true) {
        const current = state.needs[needId] ?? 60;
        const next = clamp(current + delta, 0, 100);
        state.needs[needId] = next;
        recomputeMoodFromNeeds();
        renderNeeds();
        renderMood(true);
        if (shouldSave) saveState();
      }

      function renderNeeds() {
        document.querySelectorAll(".need-row").forEach(row => {
          const needId = row.getAttribute("data-need-id");
          const value = state.needs[needId] ?? 60;
          const fill = row.querySelector("[data-need-fill]");
          const label = row.querySelector("[data-need-value]");
          if (fill) fill.style.width = `${value}%`;
          if (label) label.textContent = Math.round(value);
        });

        const vals = Object.values(state.needs);
        const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
        const dotsOn =
          avg >= 75 ? 3 :
          avg >= 45 ? 2 :
          avg >= 20 ? 1 : 0;
        [dot1, dot2, dot3].forEach((dot, i) => {
          if (!dot) return;
          dot.classList.toggle("on", i < dotsOn);
        });
      }

      function recomputeMoodFromNeeds() {
        const vals = Object.values(state.needs);
        const avgNeeds = vals.reduce((a, b) => a + b, 0) / vals.length;

        let base = avgNeeds;
        const tone = state.mood.lastFeelingTone || "neutral";

        if (tone === "good") base += 5;
        if (tone === "low") base -= 5;

        state.mood.score = clamp(base, 0, 100);

        if (!state.mood.labelMain) {
          state.mood.labelMain = "Gently okay";
          state.mood.labelSub = "You‚Äôre doing more than enough.";
        }
      }

      function renderMood(shouldPlaySound) {
        const score = state.mood.score ?? 60;
        const prevTier = state.mood.tier || "neutral";

        let tier = "neutral";
        if (score < 40) tier = "low";
        else if (score >= 70) tier = "good";

        state.mood.tier = tier;

        moodLabelMain.textContent = state.mood.labelMain || "Gently okay";
        moodLabelSub.textContent = state.mood.labelSub || "You‚Äôre doing more than enough.";

        moodGaugeFill.style.width = `${clamp(score, 5, 100)}%`;

        plumbob.classList.remove("low", "neutral", "good");
        plumbob.classList.add(tier);

        if (shouldPlaySound && tier !== prevTier) {
          if (tier === "good") playSound("feel-good");
          else if (tier === "neutral") playSound("feel-neutral");
          else playSound("feel-low");
        }

        state.mood.lastTier = tier;
      }

      function addMoodlet({ id, label, tone }) {
        const existingIndex = state.moodlets.findIndex(m => m.id === id);
        if (existingIndex >= 0) {
          state.moodlets[existingIndex] = { id, label, tone };
        } else {
          state.moodlets.push({ id, label, tone });
          if (state.moodlets.length > 4) {
            state.moodlets.shift();
          }
        }
      }

      function renderMoodlets() {
        moodletBar.innerHTML = "";
        state.moodlets.forEach(m => {
          const div = document.createElement("div");
          div.className = "moodlet-chip";
          div.dataset.tone = m.tone || "neutral";
          div.innerHTML = `
            <span class="moodlet-dot"></span>
            <span>${m.label}</span>
          `;
          moodletBar.appendChild(div);
        });
      }

      function updateWinFlagForToday() {
        const completed = state.today.completedTaskIds;
        const isWin = completed.length > 0 || state.today.badDay;
        const key = state.todayDate;
        const previous = !!state.winsByDate[key];
        state.winsByDate[key] = isWin;
        if (isWin && !previous) {
          state.stats.daysWin += 1;
        } else if (!isWin && previous) {
          state.stats.daysWin = Math.max(0, state.stats.daysWin - 1);
        }
      }

      function renderCalendar() {
        const now = new Date(state.todayDate + "T00:00:00");
        const year = now.getFullYear();
        const month = now.getMonth();
        const first = new Date(year, month, 1);
        const firstDay = first.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        calendarGrid.innerHTML = "";
        const monthName = now.toLocaleDateString(undefined, { month: "long", year: "numeric" });
        calendarMonthLabel.textContent = monthName;

        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement("div");
          calendarGrid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const div = document.createElement("div");
          div.className = "calendar-day";
          div.textContent = day;
          if (state.winsByDate[dateStr]) div.classList.add("win");
          if (dateStr === state.todayDate) div.classList.add("today");
          calendarGrid.appendChild(div);
        }
      }

      function renderJournals() {
        const dKey = state.todayDate;
        const mKey = getMonthKey(state.todayDate);
        const yKey = getYearKey(state.todayDate);

        journalDay.value = state.journals.day[dKey] || "";
        journalMonth.value = state.journals.month[mKey] || "";
        journalYear.value = state.journals.year[yKey] || "";
      }

      // Needs decay over real time (even if app was closed)
      function updateNeedsOverTime(initial) {
        const now = Date.now();
        if (!state.lastNeedsUpdate) {
          state.lastNeedsUpdate = now;
          return;
        }
        const elapsedMs = now - state.lastNeedsUpdate;
        const elapsedMin = Math.floor(elapsedMs / 60000);
        if (elapsedMin <= 0) return;

        state.lastNeedsUpdate += elapsedMin * 60000;

        let changed = false;
        for (const needId in state.needs) {
          const rate = needsDecayPerMinute[needId] || 0;
          if (!rate) continue;
          const dec = rate * elapsedMin;
          const before = state.needs[needId];
          const after = clamp(before - dec, 0, 100);
          if (after !== before) {
            state.needs[needId] = after;
            changed = true;
          }
        }

        if (changed) {
          recomputeMoodFromNeeds();
          if (!initial) {
            renderNeeds();
            renderMood(true);
          }
          saveState();
        }
      }

      // Timers & needs tick
      function startTimersTick() {
        if (timersInterval) clearInterval(timersInterval);
        tickTimers(); // initial tick
        renderTimers();
        timersInterval = setInterval(() => {
          updateNeedsOverTime(false);
          tickTimers();
          renderTimers();
        }, 1000);
      }

      function tickTimers() {
        const now = Date.now();
        let changed = false;

        for (const id in state.timers) {
          const t = state.timers[id];
          if (!t.isRunning || !t.lastStart) continue;

          const elapsed = now - t.lastStart;
          const remaining = t.remainingMs - elapsed;

          if (remaining <= 0) {
            t.remainingMs = 0;
            t.isRunning = false;
            t.lastStart = null;
            t.completedCount = (t.completedCount || 0) + 1;

            if (id === "shower" || id === "skincare") {
              state.stats.selfCareBonuses += 1;
              addMoodlet({
                id: `timer-${id}`,
                label: id === "shower" ? "Cozy shower buff" : "Skincare glow buff",
                tone: "good"
              });
            }

            changed = true;
          } else {
            t.remainingMs = remaining;
            t.lastStart = now;
            changed = true;
          }
        }

        if (changed) {
          renderStats();
          renderMoodlets();
          saveState();
        }
      }

      function renderTimers() {
        document.querySelectorAll(".timer-row").forEach(row => {
          const id = row.getAttribute("data-timer-id");
          const statusEl = row.querySelector("[data-timer-status]");
          const timer = state.timers[id];
          if (!timer) return;

          let label = "Off";
          let due = false;

          if (timer.isRunning && timer.remainingMs > 0) {
            const minutes = Math.floor(timer.remainingMs / 60000);
            const seconds = Math.floor((timer.remainingMs % 60000) / 1000);
            label = `${minutes}m ${String(seconds).padStart(2, "0")}s`;
          } else if (!timer.isRunning && timer.remainingMs > 0) {
            const minutes = Math.ceil(timer.remainingMs / 60000);
            label = `${minutes}m left`;
          } else if (!timer.isRunning && timer.remainingMs === 0 && timer.completedCount > 0) {
            label = "Due";
            due = true;
          }

          statusEl.textContent = label;
          statusEl.classList.toggle("due", due);
        });
      }

      function startTimer(id) {
        const t = state.timers[id];
        if (!t) return;

        if (t.remainingMs <= 0) {
          t.remainingMs = (t.durationMinutes || defaultTimersConfig[id].minutes) * 60000;
        }

        t.isRunning = true;
        t.lastStart = Date.now();
        saveState();
        renderTimers();
      }

      function stopTimer(id) {
        const t = state.timers[id];
        if (!t) return;
        t.isRunning = false;
        t.lastStart = null;
        saveState();
        renderTimers();
      }

      function clamp(val, min, max) {
        return Math.max(min, Math.min(max, val));
      }

      // PWA service worker registration
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(() => {});
      }
    })();
  </script>
</body>
</html>

