<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KSim Home ‚Äì CAS Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --accent: #00b2c8;
      --accent-soft: #7edbe4;
      --leaf: #5da66a;
      --soft-bg: #f6f3ea;
      --card-bg: rgba(11, 31, 38, 0.95);
      --card-soft: rgba(255, 255, 255, 0.06);
      --border-soft: rgba(255, 255, 255, 0.14);
      --text-main: #e9f9ff;
      --text-soft: #c2d8e4;
      --hud-bg: rgba(8, 22, 29, 0.98);
      --sky-top: #a9e4ff;
      --sky-mid: #63b1ff;
      --sky-bottom: #20539b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 14px 35px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      background: radial-gradient(circle at top, var(--sky-top) 0, var(--sky-mid) 40%, var(--sky-bottom) 100%);
      color: var(--text-main);
      overflow: hidden;
    }

    .cas-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    /* Mood color themes */
    .cas-shell.mood-good .sim-mood-tag {
      background: rgba(77, 241, 141, 0.18);
      box-shadow: 0 0 0 1px rgba(180, 255, 207, 0.8);
    }
    .cas-shell.mood-neutral .sim-mood-tag {
      background: rgba(246, 210, 91, 0.18);
      box-shadow: 0 0 0 1px rgba(255, 235, 180, 0.8);
    }
    .cas-shell.mood-low .sim-mood-tag {
      background: rgba(255, 134, 125, 0.25);
      box-shadow: 0 0 0 1px rgba(255, 178, 169, 0.85);
    }

    .cas-shell.mood-good .hud {
      background: radial-gradient(circle at top, #083526 0, #081c16 40%, #040c0a 100%);
    }
    .cas-shell.mood-neutral .hud {
      background: radial-gradient(circle at top, #35300a 0, #1e1b09 40%, #050504 100%);
    }
    .cas-shell.mood-low .hud {
      background: radial-gradient(circle at top, #3a1111 0, #1b0507 40%, #050204 100%);
    }

    .cas-topbar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: linear-gradient(90deg, rgba(12, 38, 50, 0.9), rgba(19, 73, 96, 0.9));
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      z-index: 5;
    }

    .top-back {
      border: none;
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 16px;
      background: rgba(0, 0, 0, 0.2);
      color: #e9f9ff;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .top-back.hidden { visibility: hidden; opacity: 0; }

    .top-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #dff6ff;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
</div>
    .top-weather {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.07);
      color: var(--text-soft);
    }

    .music-toggle {
      border-radius: 999px;
      border: none;
      padding: 3px 7px;
      font-size: 13px;
      background: rgba(0, 0, 0, 0.3);
      color: #eaf8ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .music-toggle.on {
      background: radial-gradient(circle at top, #42f5c5 0, #1eb1c8 45%, #0e5d7a 100%);
      color: #021015;
    }

    .cas-main {
      flex: 1;
      display: flex;
      position: relative;
      overflow: hidden;
    }

        .need-bar-left {
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 2;
    }

    .need-dot {
  border: 1px solid rgba(255, 255, 255, 0.25);
  width: 46px;
  height: 46px;
  border-radius: 14px;
  background: radial-gradient(circle at top, #6fe7ff 0, #11a7c8 45%, #06465d 100%);
  box-shadow: 0 5px 16px rgba(0, 0, 0, 0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #f8feff;
  font-size: 18px;
  transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
}

.need-dot:active {
  transform: translateY(1px) scale(0.96);
  box-shadow: 0 2px 8px rgba(0,0,0,0.6);
  filter: brightness(0.95);
}

    .cas-character-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 90px;
      transition: transform 0.4s ease, filter 0.3s ease, opacity 0.3s ease;
      z-index: 1;
    }

    .cas-shell.panel-open .cas-character-area {
      align-items: flex-start;
      transform: translateX(-17%);
      filter: brightness(0.9);
    }

    @media (min-width: 480px) {
      .cas-shell.panel-open .cas-character-area {
        transform: translateX(-20%);
      }
    }

    .sim-room {
      position: relative;
      width: 100%;
      max-width: 280px;
      height: 260px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .sim-floor-shadow {
      position: absolute;
      bottom: 14px;
      width: 120px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 0, 0, 0.6), transparent 70%);
      filter: blur(4px);
      z-index: 0;
    }

    .sim-avatar {
      position: relative;
      z-index: 1;
      width: 210px;
      height: auto;
      cursor: pointer;
      object-fit: contain;
      transition: transform 0.25s ease;
      image-rendering: auto;
      -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0.2) 100%);
      mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0.2) 100%);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
    }

    .cas-shell.panel-open .sim-avatar {
      transform: scale(1.02);
    }

    .sim-meta {
      margin-top: 4px;
      text-align: center;
      color: #eaf8ff;
    }

    .sim-meta-main {
      font-size: 15px;
      font-weight: 600;
    }

    .sim-meta-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sim-mood-tag {
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      box-shadow: 0 0 0 1px rgba(154, 255, 193, 0.35);
    }

    .sim-hint {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
      text-align: center;
    }

    /* RIGHT PANEL */
    .cas-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 76%;
      max-width: 380px;
      height: 100%;
      background: radial-gradient(circle at top, #1d4e70 0, #0b1e26 55%, #061116 100%);
      border-radius: 20px 0 0 0;
      box-shadow: -12px 0 28px rgba(0, 0, 0, 0.7);
      transform: translateX(100%);
      transition: transform 0.38s ease;
      display: flex;
      flex-direction: column;
      padding: 8px 8px 10px;
      z-index: 3;
    }

    .cas-shell.panel-open .cas-panel {
      transform: translateX(0);
    }

    .cas-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .cas-tab-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 5px 9px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(13, 51, 68, 0.95), rgba(21, 97, 130, 0.95));
      color: var(--text-soft);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.45);
      white-space: nowrap;
    }

    .cas-tab-btn span.icon {
      font-size: 15px;
    }

    .cas-tab-btn.active {
      background: radial-gradient(circle at top, #42f5c5 0, #1eb1c8 45%, #0e5d7a 100%);
      color: #042026;
      border-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 2px rgba(212, 255, 248, 0.65), 0 8px 18px rgba(0, 0, 0, 0.65);
    }

    .cas-panel-body {
      flex: 1;
      border-radius: 14px;
      background: rgba(3, 9, 13, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px;
      overflow-y: auto;
    }

    .cas-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 4px;
      color: #eaf8ff;
    }

    .cas-section-title span.sub {
      font-size: 10px;
      color: var(--text-soft);
    }

    .category-view {
      display: none;
      animation: fadeIn 0.25s ease;
    }
    .category-view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Emotions list */
    .feeling-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .feeling-card {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(135deg, rgba(22, 62, 82, 0.9), rgba(17, 78, 110, 0.9));
      padding: 6px 7px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
    }

    .feeling-card-header {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .feeling-card span.icon {
      font-size: 14px;
    }

    .feeling-tone-good { border-color: rgba(157, 255, 204, 0.75); }
    .feeling-tone-low { border-color: rgba(255, 160, 160, 0.75); }
    .feeling-tone-neutral { border-color: rgba(255, 229, 170, 0.7); }

    .feeling-card.active {
      box-shadow: 0 0 0 2px rgba(212, 255, 248, 0.9);
    }

    .feeling-card-sub {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Needs list */
    .needs-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .need-row {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) 2fr auto;
      gap: 8px;
      align-items: center;
      font-size: 11px;
    }

    .need-label {
      font-weight: 500;
    }

    .need-bar-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      overflow: hidden;
      position: relative;
    }

    .need-bar-fill {
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.25s ease;
    }

    .need-controls {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .btn-need {
      border-radius: 999px;
      border: none;
      padding: 2px 7px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.12);
      color: #eaf8ff;
    }

    .need-value {
      min-width: 26px;
      text-align: right;
      color: var(--text-soft);
    }

    /* Recipes, Haircare, Timers forms */
    .recipe-form,
    .hair-form {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .recipe-row,
    .hair-row {
      display: flex;
      gap: 4px;
    }

    .recipe-row input,
    .hair-row input {
      flex: 1;
    }

    .recipe-form input,
    .recipe-form textarea,
    .hair-form input,
    .hair-form textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(4, 14, 18, 0.8);
      padding: 5px 7px;
      color: #eaf8ff;
      font-size: 11px;
      font-family: inherit;
    }

    .recipe-form textarea,
    .hair-form textarea {
      min-height: 46px;
      resize: vertical;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 5px 9px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at top, #42f5c5 0, #1eb1c8 45%, #0e5d7a 100%);
      color: #021014;
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.55);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .recipe-list,
    .hair-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .recipe-card,
    .hair-card {
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(15, 51, 66, 0.95), rgba(10, 31, 40, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 6px 7px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      cursor: pointer;
    }

    .recipe-card-header,
    .hair-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recipe-card-title,
    .hair-card-title {
      font-weight: 600;
    }

    .recipe-card-cat,
    .hair-card-cat {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 9px;
      background: rgba(5, 170, 220, 0.18);
      color: var(--accent-soft);
    }

    .recipe-card-notes,
    .hair-card-notes {
      font-size: 10px;
      color: var(--text-soft);
    }

    .recipe-card.active,
    .hair-card.active {
      box-shadow: 0 0 0 2px rgba(212, 255, 248, 0.9);
    }

    .filter-row {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .filter-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(4, 14, 18, 0.8);
      padding: 4px 7px;
      color: #eaf8ff;
    }

    .filter-row span {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Skills */
    .skill-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .skill-row {
      padding: 6px 7px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(17, 60, 79, 0.96), rgba(8, 30, 40, 0.96));
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 11px;
    }

    .skill-header-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .skill-bar-shell {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      overflow: hidden;
    }

    .skill-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-soft), var(--accent));
      transition: width 0.25s ease;
    }

    .skill-meta {
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    /* Baking info */
    .baking-note {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    /* Timers */
    .timer-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
    }

    .timer-row {
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(16, 53, 68, 0.95), rgba(12, 32, 42, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 6px 7px;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) auto auto;
      gap: 6px;
      align-items: center;
    }

    .timer-name {
      font-weight: 500;
    }
    .timer-status {
      font-size: 10px;
      color: var(--text-soft);
    }

    .timer-time {
      text-align: right;
      font-size: 11px;
      color: #eaf8ff;
    }

    .timer-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.15);
      color: #eaf8ff;
    }

    .timer-btn.active {
      background: radial-gradient(circle at top, #42f5c5 0, #1eb1c8 45%, #0e5d7a 100%);
      color: #021015;
    }

    .hud {
      flex-shrink: 0;
      background: var(--hud-bg);
      color: #e7f7ff;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.6);
      z-index: 4;
    }

    .portrait {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: radial-gradient(circle at 25% 20%, #fdf7ef, #4b2d1d);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      color: #fdf9f2;
      box-shadow: 0 0 0 2px #fff, 0 4px 10px rgba(0, 0, 0, 0.6);
      flex-shrink: 0;
      cursor: pointer;
      overflow: hidden;
    }

    .portrait img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .hud-middle {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .hud-top-line {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .plumbob {
      width: 22px;
      height: 32px;
      position: relative;
      flex-shrink: 0;
    }

    .plumbob-shape {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, #4df18d, #178348);
      clip-path: polygon(50% 0, 100% 50%, 50% 100%, 0 50%);
      box-shadow: 0 0 10px rgba(154, 255, 180, 0.9);
    }

    @media (max-width: 380px) {
      .plumbob { width: 20px; height: 28px; }
    }

    .hud-mood-label-main {
      font-size: 12px;
      font-weight: 600;
    }

    .hud-mood-label-sub {
      font-size: 11px;
      color: #bdd5df;
    }

    .mood-gauge {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }

    .mood-fill {
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, #f6c15b, #3fa76a);
      transition: width 0.3s ease, background 0.25s ease;
    }

    .hud-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 3px;
    }

    .needs-dots {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
    }

    .dot.active {
      background: #e7f6ff;
      box-shadow: 0 0 5px rgba(202, 246, 255, 0.9);
    }

    .hud-hint {
      font-size: 9px;
      color: #8ea6b2;
    }

    /* Overlay when panel open */
    .cas-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.15) 0, rgba(0,0,0,0.65) 70%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
      z-index: 2;
    }

    .cas-shell.panel-open .cas-overlay {
      opacity: 1;
      pointer-events: auto;
    }

    /* XP float */
    .xp-float {
      position: absolute;
      transform: translate(-50%, 0);
      font-size: 12px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0, 178, 200, 0.96);
      color: #ffffff;
      pointer-events: none;
      opacity: 0;
      z-index: 9999;
      transition: transform 0.6s ease-out, opacity 0.6s ease-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }
    .xp-float-show { opacity: 1; transform: translate(-50%, -10px); }
    .xp-float-hide { opacity: 0; transform: translate(-50%, -30px); }
    .hygiene-menu {
  position: absolute;
  left: 60px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  flex-direction: column;
  gap: 6px;
  padding: 8px;
  border-radius: 14px;
  background: radial-gradient(circle at top, #173b4c 0, #050f15 70%);
  box-shadow: 0 8px 24px rgba(0,0,0,0.7);
  z-index: 3;
}

.hygiene-menu.open {
  display: flex;
}

.hygiene-menu button {
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.2);
  padding: 5px 10px;
  font-size: 11px;
  display: flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, rgba(22,88,109,0.95), rgba(11,39,51,0.95));
  color: #eaf8ff;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}
.hygiene-menu button:active {
  transform: translateY(1px);
  box-shadow: 0 1px 5px rgba(0,0,0,0.6);
}
  </style>
</head>
<body>
  <div class="cas-shell" id="casShell">
    <div class="cas-topbar">
      <button id="backHomeBtn" class="top-back hidden" type="button">‚Üê</button>
      <div class="top-title">KSim CAS</div>
            <div class="top-right">
        <button class="music-toggle" id="musicToggle" type="button">‚ô´ Off</button>
        <button class="music-toggle" id="musicSkip" type="button">‚Üª</button>
        <div id="weatherChip" class="top-weather">
        </div>
      </div>

    <div class="cas-main">

      <!-- LEFT NEED QUICK-BAR -->
      <div class="need-bar-left" id="needBarLeft">
        <button class="need-dot" type="button" data-action="drink">ü•§</button>
        <button class="need-dot" type="button" data-action="snack">üç´</button>
        <button class="need-dot" type="button" data-action="meal">üçΩ</button>
        <button class="need-dot" type="button" data-action="hygiene">‚ú®</button>
        <button class="need-dot" type="button" data-action="homeschool">üìö</button>
        <button class="need-dot" type="button" data-action="entertain">üì∫</button>
        <button class="need-dot" type="button" data-action="clean">üßΩ</button>
        <button class="need-dot" type="button" data-action="exercise">üèãÔ∏è</button>
      </div>
      
            <!-- Hygiene sub menu -->
      <div class="hygiene-menu" id="hygieneMenu">
        <button type="button" data-hygiene="toilet">üöΩ Toilet</button>
        <button type="button" data-hygiene="shower">üöø Shower</button>
        <button type="button" data-hygiene="teeth">ü™• Teeth</button>
        <button type="button" data-hygiene="haircare">üíá‚Äç‚ôÄÔ∏è Hair</button>
        <button type="button" data-hygiene="skincare">üß¥ Skin</button>
      </div>

      <div class="cas-character-area" id="characterArea">
        <div class="sim-room">
          <div class="sim-floor-shadow"></div>
          <img id="simAvatar" class="sim-avatar" src="images/kelly-fine.png" alt="Kelly Sim" />
        </div>
        <div class="sim-meta">
          <div class="sim-meta-main" id="simMoodTitle">Gently okay</div>
          <div class="sim-meta-sub" id="simMoodSub">You‚Äôre doing more than enough.</div>
          <div class="sim-mood-tag" id="simMoodTag">
            <span>üíö</span><span>Soft & steady</span>
          </div>
        </div>
        <div class="sim-hint">Tap Kelly to open her Sims-style menu.</div>
      </div>

      <aside class="cas-panel" id="casPanel">
        <div class="cas-tabs">
          <button class="cas-tab-btn active" data-category="emotions" type="button">
            <span class="icon">üí¨</span><span>Emotions</span>
          </button>
          <button class="cas-tab-btn" data-category="needs" type="button">
            <span class="icon">üíö</span><span>Needs</span>
          </button>
          <button class="cas-tab-btn" data-category="recipes" type="button">
            <span class="icon">üìö</span><span>Recipes</span>
          </button>
          <button class="cas-tab-btn" data-category="baking" type="button">
            <span class="icon">üßÅ</span><span>Baking</span>
          </button>
          <button class="cas-tab-btn" data-category="hair" type="button">
            <span class="icon">üíá</span><span>HairCare</span>
          </button>
          <button class="cas-tab-btn" data-category="timers" type="button">
            <span class="icon">‚è∞</span><span>Timers</span>
          </button>
          <button class="cas-tab-btn" data-category="skills" type="button">
            <span class="icon">‚≠ê</span><span>Skills</span>
          </button>
        </div>

        <div class="cas-panel-body">
          <!-- Emotions view -->
          <div class="category-view active" data-category-view="emotions">
            <div class="cas-section-title">
              <span>Emotional state</span>
              <span class="sub">Tap whatever feels closest.</span>
            </div>
            <div class="feeling-grid" id="feelingGrid">
              <!-- low -->
              <div class="feeling-card feeling-tone-low" data-feeling="stressed" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">‚ö°</span><span>Stressed</span>
                </div>
                <div class="feeling-card-sub">Brain juggling a lot.</div>
              </div>
              <div class="feeling-card feeling-tone-low" data-feeling="overwhelmed" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">üåä</span><span>Overwhelmed</span>
                </div>
                <div class="feeling-card-sub">Too much on one person.</div>
              </div>
              <div class="feeling-card feeling-tone-low" data-feeling="sad" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">üíß</span><span>Sad</span>
                </div>
                <div class="feeling-card-sub">Soft heaviness allowed.</div>
              </div>
              <div class="feeling-card feeling-tone-low" data-feeling="angry" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">üî•</span><span>Angry</span>
                </div>
                <div class="feeling-card-sub">Boundary alarm, not failure.</div>
              </div>
              <div class="feeling-card feeling-tone-low" data-feeling="uncomfortable" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">üò£</span><span>Uncomfortable</span>
                </div>
                <div class="feeling-card-sub">Body saying ‚Äúsomething‚Äôs off‚Äù.</div>
              </div>
              <div class="feeling-card feeling-tone-low" data-feeling="scared" data-tone="low">
                <div class="feeling-card-header">
                  <span class="icon">üò±</span><span>Scared</span>
                </div>
                <div class="feeling-card-sub">Nervous system on alert.</div>
              </div>

              <!-- neutral -->
              <div class="feeling-card feeling-tone-neutral" data-feeling="hungry" data-tone="neutral">
                <div class="feeling-card-header">
                  <span class="icon">üçû</span><span>Hungry</span>
                </div>
                <div class="feeling-card-sub">Body asking for fuel.</div>
              </div>
              <div class="feeling-card feeling-tone-neutral" data-feeling="focused" data-tone="neutral">
                <div class="feeling-card-header">
                  <span class="icon">üéØ</span><span>Focused</span>
                </div>
                <div class="feeling-card-sub">Dialed in on tasks.</div>
              </div>
              <div class="feeling-card feeling-tone-neutral" data-feeling="inspired" data-tone="neutral">
                <div class="feeling-card-header">
                  <span class="icon">üí°</span><span>Inspired</span>
                </div>
                <div class="feeling-card-sub">Little spark worth keeping.</div>
              </div>

              <!-- good -->
              <div class="feeling-card feeling-tone-good" data-feeling="happy" data-tone="good">
                <div class="feeling-card-header">
                  <span class="icon">üòä</span><span>Happy</span>
                </div>
                <div class="feeling-card-sub">Joy is allowed here.</div>
              </div>
              <div class="feeling-card feeling-tone-good" data-feeling="playful" data-tone="good-playful">
                <div class="feeling-card-header">
                  <span class="icon">üéà</span><span>Playful</span>
                </div>
                <div class="feeling-card-sub">A little silly is medicine.</div>
              </div>
              <div class="feeling-card feeling-tone-good" data-feeling="flirty" data-tone="good-flirty">
                <div class="feeling-card-header">
                  <span class="icon">üíñ</span><span>Flirty</span>
                </div>
                <div class="feeling-card-sub">Still a whole person, not just ‚Äúmom‚Äù.</div>
              </div>
              <div class="feeling-card feeling-tone-good" data-feeling="peace" data-tone="good">
                <div class="feeling-card-header">
                  <span class="icon">üïäÔ∏è</span><span>Peace</span>
                </div>
                <div class="feeling-card-sub">Tiny pocket of calm.</div>
              </div>
              <div class="feeling-card feeling-tone-good" data-feeling="ease" data-tone="good">
                <div class="feeling-card-header">
                  <span class="icon">üåø</span><span>Ease</span>
                </div>
                <div class="feeling-card-sub">Moving softer, still worthy.</div>
              </div>
            </div>
          </div>

          <!-- Needs view -->
          <div class="category-view" data-category-view="needs">
            <div class="cas-section-title">
              <span>Needs board</span>
              <span class="sub">Gauges, not grades.</span>
            </div>
            <div class="needs-list">
              <div class="need-row" data-need-id="hunger">
                <div class="need-label">Hunger</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
              <div class="need-row" data-need-id="energy">
                <div class="need-label">Energy</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
              <div class="need-row" data-need-id="social">
                <div class="need-label">Social</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
              <div class="need-row" data-need-id="fun">
                <div class="need-label">Fun</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
              <div class="need-row" data-need-id="hygiene">
                <div class="need-label">Hygiene</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
              <div class="need-row" data-need-id="quiet">
                <div class="need-label">Quiet / Alone</div>
                <div class="need-bar-shell">
                  <div class="need-bar-fill" data-need-fill></div>
                </div>
                <div class="need-controls">
                  <button class="btn-need" data-need-delta="-10" type="button">‚àí</button>
                  <span class="need-value" data-need-value>60</span>
                  <button class="btn-need" data-need-delta="10" type="button">+</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Recipes view -->
          <div class="category-view" data-category-view="recipes">
            <div class="cas-section-title">
              <span>Recipe tracker</span>
              <span class="sub">Tiny Solopa cookbook.</span>
            </div>

            <form class="recipe-form" id="recipeForm">
              <div class="recipe-row">
                <input type="text" id="recipeName" placeholder="Recipe name (e.g. Sunshine Juice)" />
              </div>
              <div class="recipe-row">
                <input type="text" id="recipeCategory" placeholder="Category tag (e.g. Juice, Soup, Baking)" />
              </div>
              <textarea id="recipeNotes" placeholder="Short notes: key ingredients, steps, or when to make it."></textarea>
              <button class="btn-primary" type="submit">
                <span class="icon">‚ûï</span><span>Add recipe</span>
              </button>
            </form>

            <div class="filter-row">
              <input type="text" id="recipeFilter" placeholder="Filter by category (e.g. Juice)" />
              <span>Tap a card to highlight.</span>
            </div>

            <div class="recipe-list" id="recipeList"></div>
          </div>

          <!-- Baking view -->
          <div class="category-view" data-category-view="baking">
            <div class="cas-section-title">
              <span>Baking regime</span>
              <span class="sub">Pulls from recipes tagged ‚ÄúBaking‚Äù.</span>
            </div>
            <div class="baking-note">
              Any recipe with category ‚ÄúBaking‚Äù (any case) will show here. Perfect for cookies, breads, muffins,
              and homestead treats.
            </div>
            <div class="recipe-list" id="bakingList"></div>
          </div>

          <!-- HairCare view -->
          <div class="category-view" data-category-view="hair">
            <div class="cas-section-title">
              <span>HairCare regime</span>
              <span class="sub">Gentle tracking for curls & crown.</span>
            </div>

            <form class="hair-form" id="hairForm">
              <div class="hair-row">
                <input type="text" id="hairName" placeholder="Routine name (e.g. Wash Day, Refresh)" />
              </div>
              <div class="hair-row">
                <input type="text" id="hairTag" placeholder="Frequency tag (e.g. Weekly, Nightly)" />
              </div>
              <textarea id="hairNotes" placeholder="Steps, products, masks, oils, etc."></textarea>
              <button class="btn-primary" type="submit">
                <span class="icon">‚ûï</span><span>Add HairCare</span>
              </button>
            </form>

            <div class="filter-row">
              <input type="text" id="hairFilter" placeholder="Filter by tag (e.g. Weekly)" />
              <span>Tap to highlight.</span>
            </div>

            <div class="hair-list" id="hairList"></div>
          </div>

          <!-- Timers view -->
          <div class="category-view" data-category-view="timers">
            <div class="cas-section-title">
              <span>Timers & nudges</span>
              <span class="sub">Soft reminders, no judgment.</span>
            </div>
            <div class="timer-list" id="timerList">
              <!-- Timers are rendered from JS -->
            </div>
          </div>

          <!-- Skills view -->
          <div class="category-view" data-category-view="skills">
            <div class="cas-section-title">
              <span>Skills & levels</span>
              <span class="sub">Every tap is XP, not pressure.</span>
            </div>
            <div class="skill-row">
              <div class="skill-header-line">
                <span>Overall Solopa level</span>
                <span id="overallLevelLabel">Lv. 1</span>
              </div>
              <div class="skill-bar-shell">
                <div class="skill-bar-fill" id="overallXpFill"></div>
              </div>
              <div class="skill-meta" id="overallXpMeta">0 / 100 XP</div>
            </div>

            <div class="skill-list">
              <div class="skill-row" data-skill-id="nourish">
                <div class="skill-header-line">
                  <span>üçΩÔ∏è Nourish</span>
                  <span id="skillLevel-nourish">Lv. 1</span>
                </div>
                <div class="skill-bar-shell">
                  <div class="skill-bar-fill" id="skillFill-nourish"></div>
                </div>
                <div class="skill-meta" id="skillMeta-nourish">0 / 100 XP</div>
              </div>

              <div class="skill-row" data-skill-id="selfCare">
                <div class="skill-header-line">
                  <span>üõÅ Self-care</span>
                  <span id="skillLevel-selfCare">Lv. 1</span>
                </div>
                <div class="skill-bar-shell">
                  <div class="skill-bar-fill" id="skillFill-selfCare"></div>
                </div>
                <div class="skill-meta" id="skillMeta-selfCare">0 / 100 XP</div>
              </div>

              <div class="skill-row" data-skill-id="homestead">
                <div class="skill-header-line">
                  <span>üè° Homestead</span>
                  <span id="skillLevel-homestead">Lv. 1</span>
                </div>
                <div class="skill-bar-shell">
                  <div class="skill-bar-fill" id="skillFill-homestead"></div>
                </div>
                <div class="skill-meta" id="skillMeta-homestead">0 / 100 XP</div>
              </div>

              <div class="skill-row" data-skill-id="mind">
                <div class="skill-header-line">
                  <span>üß† Mind</span>
                  <span id="skillLevel-mind">Lv. 1</span>
                </div>
                <div class="skill-bar-shell">
                  <div class="skill-bar-fill" id="skillFill-mind"></div>
                </div>
                <div class="skill-meta" id="skillMeta-mind">0 / 100 XP</div>
              </div>

              <div class="skill-row" data-skill-id="story">
                <div class="skill-header-line">
                  <span>üìñ Story</span>
                  <span id="skillLevel-story">Lv. 1</span>
                </div>
                <div class="skill-bar-shell">
                  <div class="skill-bar-fill" id="skillFill-story"></div>
                </div>
                <div class="skill-meta" id="skillMeta-story">0 / 100 XP</div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <div class="cas-overlay" id="casOverlay"></div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="portrait" id="hudPortrait">
        <img id="hudPortraitImg" src="images/kelly-fine-home.png" alt="Kelly headshot" />

      </div>
      <div class="hud-middle">
        <div class="hud-top-line">
          <div class="plumbob">
            <div class="plumbob-shape" id="plumbobShape"></div>
          </div>
          <div>
            <div class="hud-mood-label-main" id="hudMoodMain">Gently okay</div>
            <div class="hud-mood-label-sub" id="hudMoodSub">You‚Äôre doing more than enough.</div>
          </div>
        </div>
        <div class="mood-gauge">
          <div class="mood-fill" id="moodFill"></div>
        </div>
      </div>
      <div class="hud-right">
        <div class="needs-dots">
          <div class="dot" id="dot1"></div>
          <div class="dot" id="dot2"></div>
          <div class="dot" id="dot3"></div>
        </div>
        <div class="hud-hint">Tap headshot to go home.</div>
      </div>
    </div>

    <!-- Sounds -->
    <audio data-sound="ui-click" src="sounds/ui-click.mp3" preload="auto"></audio>
    <audio data-sound="feel-good" src="sounds/feel-good.mp3" preload="auto"></audio>
    <audio data-sound="feel-neutral" src="sounds/feel-neutral.mp3" preload="auto"></audio>
    <audio data-sound="feel-low" src="sounds/feel-low.mp3" preload="auto"></audio>
    <audio data-sound="feel-playful" src="sounds/feel-playful.mp3" preload="auto"></audio>
    <audio data-sound="feel-flirty" src="sounds/feel-flirty.mp3" preload="auto"></audio>
    <audio data-sound="timer-alarm" src="sounds/timer-alarm.mp3" preload="auto"></audio>
    <audio data-sound="feel-energized" src="sounds/feel-energized.mp3" preload="auto"></audio>
    <!-- Background music -->
    <audio id="bgMusic" src="sounds/bg-music.mp3" preload="auto" loop></audio>
  </div>

  <script>
  (function () {
    const STORAGE_KEY = "ksim_cas_v2";

    const needsDecayPerMinute = {
      hunger: 0.5,
      energy: 0.4,
      social: 0.25,
      fun: 0.25,
      hygiene: 0.2,
      quiet: 0.2
    };

    const timersConfig = {
      hydration: { label: "Hydration", minutes: 45, skill: "nourish" },
      meal: { label: "Meal", minutes: 180, skill: "nourish" },
      snack: { label: "Snack", minutes: 90, skill: "nourish" },
      bathroom: { label: "Bathroom", minutes: 120, skill: "selfCare" },
      shower: { label: "Shower", minutes: 30, skill: "selfCare" },
      skincare: { label: "Skincare", minutes: 20, skill: "selfCare" }
    };

    // Kelly expression sprites
    const moodImages = {
      happy: "images/kelly-happy.png",
      playful: "images/kelly-playful.png",
      flirty: "images/kelly-flirty.png",
      inspired: "images/kelly-inspired.png",
      focused: "images/kelly-focused.png",
      fine: "images/kelly-fine.png",
      sad: "images/kelly-sad.png",
      upset: "images/kelly-upset.png",
      embarrassed: "images/kelly-embarrassed.png",
      uncomfortable: "images/kelly-uncomfortable.png",
      scared: "images/kelly-scared.png",
      aspired: "images/kelly-aspired.png"
    };

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function xpForLevel(level) {
      return level * 100;
    }

    function freshState() {
      const timersState = {};
      Object.keys(timersConfig).forEach((id) => {
        timersState[id] = { active: false, endAt: null };
      });

      return {
        version: 2,
        needs: {
          hunger: 65,
          energy: 60,
          social: 55,
          fun: 60,
          hygiene: 70,
          quiet: 55
        },
        lastNeedsUpdate: Date.now(),
        mood: {
          score: 62,
          labelMain: "Gently okay",
          labelSub: "You‚Äôre doing more than enough.",
          lastTier: "neutral",
          lastScore: 62
        },
        skills: {
          overallXP: 0,
          overallLevel: 1,
          skills: {
            nourish: { xp: 0, level: 1 },
            selfCare: { xp: 0, level: 1 },
            homestead: { xp: 0, level: 1 },
            mind: { xp: 0, level: 1 },
            story: { xp: 0, level: 1 }
          }
        },
        recipes: [],
        haircare: [],
        timers: timersState,
        bgMusicOn: true,
        _lastFeeling: null
      };
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return freshState();
      try {
        const parsed = JSON.parse(raw);
        const base = freshState();
        return Object.assign(base, parsed, {
          skills: Object.assign(base.skills, parsed.skills || {}),
          needs: Object.assign(base.needs, parsed.needs || {}),
          timers: Object.assign(base.timers, parsed.timers || {}),
          recipes: parsed.recipes || [],
          haircare: parsed.haircare || []
        });
      } catch {
        return freshState();
      }
    }

    let state = loadState();
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // DOM references
    const casShell = document.getElementById("casShell");
    const simAvatar = document.getElementById("simAvatar");
    const simMoodTitle = document.getElementById("simMoodTitle");
    const simMoodSub = document.getElementById("simMoodSub");
    const simMoodTag = document.getElementById("simMoodTag");

    const hudMoodMain = document.getElementById("hudMoodMain");
    const hudMoodSub = document.getElementById("hudMoodSub");
    const moodFill = document.getElementById("moodFill");
    const dot1 = document.getElementById("dot1");
    const dot2 = document.getElementById("dot2");
    const dot3 = document.getElementById("dot3");
    const plumbobShape = document.getElementById("plumbobShape");
    const hudPortrait = document.getElementById("hudPortrait");
    const hudPortraitImg = document.getElementById("hudPortraitImg");

    const casPanel = document.getElementById("casPanel");
    const casOverlay = document.getElementById("casOverlay");
    const backHomeBtn = document.getElementById("backHomeBtn");
    const weatherChip = document.getElementById("weatherChip");
    const musicToggle = document.getElementById("musicToggle");
    const musicSkip = document.getElementById("musicSkip");
    const bgMusic = document.getElementById("bgMusic");

    const feelingGrid = document.getElementById("feelingGrid");
    const needRows = document.querySelectorAll(".need-row");

    const recipeForm = document.getElementById("recipeForm");
    const recipeNameInput = document.getElementById("recipeName");
    const recipeCategoryInput = document.getElementById("recipeCategory");
    const recipeNotesInput = document.getElementById("recipeNotes");
    const recipeList = document.getElementById("recipeList");
    const recipeFilterInput = document.getElementById("recipeFilter");
    const bakingList = document.getElementById("bakingList");

    const hairForm = document.getElementById("hairForm");
    const hairNameInput = document.getElementById("hairName");
    const hairTagInput = document.getElementById("hairTag");
    const hairNotesInput = document.getElementById("hairNotes");
    const hairList = document.getElementById("hairList");
    const hairFilterInput = document.getElementById("hairFilter");

    const timerList = document.getElementById("timerList");
    const needBarLeft = document.getElementById("needBarLeft");
    const hygieneMenu = document.getElementById("hygieneMenu");

    const overallLevelLabel = document.getElementById("overallLevelLabel");
    const overallXpFill = document.getElementById("overallXpFill");
    const overallXpMeta = document.getElementById("overallXpMeta");
    const casTabButtons = document.querySelectorAll(".cas-tab-btn");
    const categoryViews = document.querySelectorAll(".category-view");

    let lastWeather = null;
    let timersInterval = null;
    let hasUserInteractedForMusic = false;

    function playSound(name) {
      const audio = document.querySelector(`audio[data-sound="${name}"]`);
      if (!audio) return;
      try {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      } catch {}
    }

    const bgTracks = [
      "sounds/bg-1.mp3",
      "sounds/bg-2.mp3",
      "sounds/bg-3.mp3"
    ];
    let currentBgIndex = Math.floor(Math.random() * bgTracks.length) || 0;

    function setBgTrack(index) {
      if (!bgMusic) return;
      currentBgIndex = index % bgTracks.length;
      bgMusic.src = bgTracks[currentBgIndex];
      bgMusic.load();
      if (state.bgMusicOn && hasUserInteractedForMusic) {
        tryPlayBgMusic();
      }
    }

    if (musicSkip) {
      musicSkip.addEventListener("click", () => {
        const next = (currentBgIndex + 1) % bgTracks.length;
        setBgTrack(next);
      });
    }

    // Global click handler for:
    // - unlocking music autoplay after first interaction
    // - closing hygiene menu on outside click
    // - UI click sounds
    document.addEventListener("click", (e) => {
      if (!hasUserInteractedForMusic) {
        hasUserInteractedForMusic = true;
        if (state.bgMusicOn) {
          tryPlayBgMusic();
        }
      }

      // Close hygiene menu when clicking outside it and the hygiene dot
      if (hygieneMenu) {
        const isHygBtn = e.target.closest('.need-dot[data-action="hygiene"]');
        const inMenu = e.target.closest("#hygieneMenu");
        if (!isHygBtn && !inMenu) {
          hygieneMenu.classList.remove("open");
        }
      }

      if (e.target.closest("button")) playSound("ui-click");
    });

    function tryPlayBgMusic() {
      if (!bgMusic) return;
      try {
        bgMusic.play().catch(() => {});
      } catch {}
    }

    function updateMusicToggle() {
      if (state.bgMusicOn) {
        musicToggle.classList.add("on");
        musicToggle.textContent = "‚ô´ On";
        if (hasUserInteractedForMusic) tryPlayBgMusic();
      } else {
        musicToggle.classList.remove("on");
        musicToggle.textContent = "‚ô´ Off";
        if (!bgMusic.paused) bgMusic.pause();
      }
    }

    musicToggle.addEventListener("click", () => {
      state.bgMusicOn = !state.bgMusicOn;
      save();
      updateMusicToggle();
    });

    function openPanel(initialCategory) {
      casShell.classList.add("panel-open");
      backHomeBtn.classList.remove("hidden");
      if (initialCategory) activateCategory(initialCategory);
    }

    function closePanel() {
      casShell.classList.remove("panel-open");
      backHomeBtn.classList.add("hidden");
    }

    simAvatar.addEventListener("click", () => {
      if (casShell.classList.contains("panel-open")) return;
      openPanel("emotions");
      if (state.mood.lastTier === "good") playSound("feel-good");
      else if (state.mood.lastTier === "low") playSound("feel-low");
      else playSound("feel-neutral");
    });

    hudPortrait.addEventListener("click", () => {
      closePanel();
    });

    backHomeBtn.addEventListener("click", () => {
      closePanel();
    });

    casOverlay.addEventListener("click", () => {
      closePanel();
    });

    function activateCategory(cat) {
      casTabButtons.forEach((btn) =>
        btn.classList.toggle("active", btn.dataset.category === cat)
      );
      categoryViews.forEach((view) =>
        view.classList.toggle(
          "active",
          view.dataset.categoryView === cat
        )
      );
    }

    casTabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const cat = btn.dataset.category;
        if (!cat) return;
        activateCategory(cat);
        if (!casShell.classList.contains("panel-open")) {
          openPanel(cat);
        }
      });
    });

    function awardXp(skillId, amount, originEl) {
      const s = state.skills;
      if (!s.skills[skillId]) return;
      s.overallXP += amount;
      s.skills[skillId].xp += amount;

      while (s.overallXP >= xpForLevel(s.overallLevel)) {
        s.overallLevel++;
      }
      const skill = s.skills[skillId];
      while (skill.xp >= xpForLevel(skill.level)) {
        skill.level++;
      }
      spawnXpFloat("+" + amount + " xp", originEl || document.body);
      save();
      renderSkills();
    }

    function spawnXpFloat(text, originEl) {
      const root = originEl.getBoundingClientRect();
      const float = document.createElement("div");
      float.className = "xp-float";
      float.textContent = text;
      const top = root.top + window.scrollY - 6;
      const left = root.left + window.scrollX + root.width / 2;
      float.style.top = top + "px";
      float.style.left = left + "px";
      document.body.appendChild(float);
      setTimeout(() => float.classList.add("xp-float-show"), 10);
      setTimeout(() => float.classList.add("xp-float-hide"), 1100);
      setTimeout(() => float.remove(), 1700);
    }

    // Needs decay every minute (when app is open)
    function updateNeedsOverTime() {
      const now = Date.now();
      const last = state.lastNeedsUpdate || now;
      const diffMin = Math.floor((now - last) / 60000);
      if (diffMin <= 0) {
        state.lastNeedsUpdate = now;
        return;
      }
      state.lastNeedsUpdate = last + diffMin * 60000;

      for (const id in state.needs) {
        const rate = needsDecayPerMinute[id] || 0;
        const before = state.needs[id];
        const after = clamp(before - rate * diffMin, 0, 100);
        state.needs[id] = after;
      }
      recomputeMood(false);
      renderNeeds();
      save();
    }

    // Weather integration for sky + chip
    function applySkyFromWeather(weather, hour) {
      const code = weather?.code ?? 0;
      let top = "#a9e4ff",
        mid = "#63b1ff",
        bottom = "#20539b";
      const isNight = hour < 6 || hour >= 21;
      if (isNight) {
        top = "#101624";
        mid = "#071225";
        bottom = "#020813";
      } else if (code >= 80) {
        top = "#deeaf4";
        mid = "#869eb8";
        bottom = "#344a67";
      } else if (code >= 45) {
        top = "#dfe4ea";
        mid = "#a3b0c0";
        bottom = "#4c5c72";
      } else {
        top = "#a9e4ff";
        mid = "#63b1ff";
        bottom = "#20539b";
      }
      const root = document.documentElement;
      root.style.setProperty("--sky-top", top);
      root.style.setProperty("--sky-mid", mid);
      root.style.setProperty("--sky-bottom", bottom);
    }

    function fetchWeatherAndUpdateSky() {
      if (!navigator.geolocation) {
        updateWeatherChip();
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
          fetch(url)
            .then((r) => r.json())
            .then((data) => {
              if (!data.current_weather) return;
              const cw = data.current_weather;
              lastWeather = {
                code: cw.weathercode,
                temp: cw.temperature,
                isDay: cw.is_day === 1
              };
              const now = new Date();
              applySkyFromWeather(lastWeather, now.getHours());
              updateWeatherChip();
            })
            .catch(() => {
              updateWeatherChip();
            });
        },
        () => {
          updateWeatherChip();
        },
        { timeout: 10000 }
      );
    }

    function updateWeatherChip() {
      const now = new Date();
      const hour = now.getHours();
      let timeLabel = "Daytime";
      if (hour < 6) timeLabel = "Early";
      else if (hour < 11) timeLabel = "Morning";
      else if (hour < 17) timeLabel = "Afternoon";
      else if (hour < 21) timeLabel = "Evening";
      else timeLabel = "Night";

      let icon = "üå§Ô∏è";
      if (lastWeather) {
        const code = lastWeather.code;
        if (code >= 80) icon = "üåßÔ∏è";
        else if (code >= 45) icon = "‚òÅÔ∏è";
        else icon = lastWeather.isDay ? "‚òÄÔ∏è" : "üåô";
      }
      weatherChip.textContent = `${icon} ${timeLabel}`;
    }

    function getBaseMoodKeyword() {
      const f = state._lastFeeling;
      const tier = state.mood.lastTier || "neutral";

      if (["happy", "playful", "flirty", "peace", "ease", "inspired"].includes(f)) {
        return "happy";
      }

      if (
        ["sad", "angry", "uncomfortable", "scared", "stressed", "overwhelmed"].includes(
          f
        )
      ) {
        return "sad";
      }

      if (["hungry", "focused"].includes(f)) {
        return "fine";
      }

      if (tier === "good") return "happy";
      if (tier === "low") return "sad";
      return "fine";
    }

    // Mood + theme + avatar
    function applySimExpression() {
      const tier = state.mood.lastTier || "neutral";
      const last = state._lastFeeling || "";
      let img = moodImages.fine || moodImages.happy;

      if (tier === "good") img = moodImages.happy;
      if (tier === "low") img = moodImages.sad;

      if (last === "happy") img = moodImages.happy;
      if (last === "playful") img = moodImages.playful;
      if (last === "flirty") img = moodImages.flirty;
      if (last === "inspired") img = moodImages.inspired;
      if (last === "focused") img = moodImages.focused;
      if (last === "sad") img = moodImages.sad;
      if (last === "angry") img = moodImages.upset || moodImages.sad;
      if (last === "uncomfortable") img = moodImages.uncomfortable;
      if (last === "scared") img = moodImages.scared;
      if (last === "stressed" || last === "overwhelmed")
        img = moodImages.upset || moodImages.uncomfortable;

      const avatarEl = simAvatar;
      if (avatarEl && img) {
        avatarEl.onerror = () => {
          avatarEl.onerror = null;
          if (moodImages.fine) avatarEl.src = moodImages.fine;
        };
        avatarEl.src = img;
      }

      const baseKey = getBaseMoodKeyword();
      const portraitPath = `images/kelly-${baseKey}-home.png`;

      if (hudPortraitImg) {
        hudPortraitImg.onerror = () => {
          hudPortraitImg.onerror = null;
          if (baseKey !== "fine") {
            hudPortraitImg.src = "images/kelly-fine-home.png";
          } else if (moodImages.fine) {
            hudPortraitImg.src = moodImages.fine;
          }
        };
        hudPortraitImg.src = portraitPath;
      }
    }

    function updateMoodTheme(tier) {
      casShell.classList.remove("mood-good", "mood-neutral", "mood-low");
      if (tier === "good") casShell.classList.add("mood-good");
      else if (tier === "low") casShell.classList.add("mood-low");
      else casShell.classList.add("mood-neutral");
    }

    function recomputeMood(shouldPlaySound) {
      const vals = Object.values(state.needs);
      const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
      const score = clamp(avg, 0, 100);
      const prevTier = state.mood.lastTier || "neutral";
      const prevScore = state.mood.lastScore ?? score;

      state.mood.score = score;

      let tier = "neutral";
      if (score < 40) tier = "low";
      else if (score >= 70) tier = "good";

      let main = state.mood.labelMain;
      let sub = state.mood.labelSub;
      if (!main) {
        main = "Gently okay";
        sub = "You‚Äôre doing more than enough.";
      }

      moodFill.style.width = clamp(score, 5, 100) + "%";
      if (tier === "good")
        moodFill.style.background =
          "linear-gradient(90deg,#a6f57c,#3fa76a)";
      else if (tier === "low")
        moodFill.style.background =
          "linear-gradient(90deg,#f66f5b,#b32828)";
      else
        moodFill.style.background =
          "linear-gradient(90deg,#f6c15b,#3fa76a)";

      if (tier === "good") {
        plumbobShape.style.background =
          "linear-gradient(180deg,#4df18d,#178348)";
        plumbobShape.style.boxShadow =
          "0 0 10px rgba(154,255,180,0.9)";
      } else if (tier === "low") {
        plumbobShape.style.background =
          "linear-gradient(180deg,#ff9b6b,#b32828)";
        plumbobShape.style.boxShadow =
          "0 0 10px rgba(255,180,164,0.9)";
      } else {
        plumbobShape.style.background =
          "linear-gradient(180deg,#f6d85b,#c97b26)";
        plumbobShape.style.boxShadow =
          "0 0 10px rgba(255,233,164,0.8)";
      }

      hudMoodMain.textContent = main;
      hudMoodSub.textContent = sub;
      simMoodTitle.textContent = main;
      simMoodSub.textContent = sub;
      simMoodTag.querySelector("span:nth-child(2)").textContent =
        tier === "good"
          ? "Bright & cozy"
          : tier === "low"
          ? "Low battery, still here"
          : "Soft & steady";

      const dotsOn =
        score >= 75 ? 3 : score >= 45 ? 2 : score >= 20 ? 1 : 0;
      [dot1, dot2, dot3].forEach((d, i) =>
        d.classList.toggle("active", i < dotsOn)
      );

      let soundPlayed = false;
      if (shouldPlaySound && tier !== prevTier) {
        if (tier === "good") playSound("feel-good");
        else if (tier === "low") playSound("feel-low");
        else playSound("feel-neutral");
        soundPlayed = true;
      }

      if (shouldPlaySound && !soundPlayed) {
        const thresholds = [25, 50, 75];
        let crossed = null;
        for (const t of thresholds) {
          if (
            (prevScore < t && score >= t) ||
            (prevScore > t && score <= t)
          ) {
            crossed = t;
            break;
          }
        }
        if (crossed !== null) {
          if (score < 40) playSound("feel-low");
          else if (score >= 70) playSound("feel-good");
          else playSound("feel-neutral");
        }
      }

      state.mood.lastTier = tier;
      state.mood.lastScore = score;

      updateMoodTheme(tier);
      applySimExpression();
    }

    // Needs rendering
    function renderNeeds() {
      needRows.forEach((row) => {
        const id = row.dataset.needId;
        const val = state.needs[id] ?? 60;
        const fill = row.querySelector("[data-need-fill]");
        const label = row.querySelector("[data-need-value]");
        if (fill) fill.style.width = val + "%";
        if (label) label.textContent = Math.round(val);
      });
    }

    needRows.forEach((row) => {
      row.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-need");
        if (!btn) return;
        const delta = parseInt(btn.dataset.needDelta, 10);
        const id = row.dataset.needId;
        const current = state.needs[id] ?? 60;
        state.needs[id] = clamp(current + delta, 0, 100);
        awardXp("selfCare", 3, row);
        recomputeMood(true);
        renderNeeds();
        save();
      });
    });

    // Left NEED BAR actions
    if (needBarLeft) {
      needBarLeft.addEventListener("click", (e) => {
        const btn = e.target.closest(".need-dot");
        if (!btn) return;
        const action = btn.dataset.action;
        if (!action) return;
        handleNeedAction(action, btn);
      });
    }

    function handleNeedAction(action, originEl) {
      switch (action) {
        case "drink":
          actDrink(originEl);
          break;
        case "snack":
          actSnack(originEl);
          break;
        case "meal":
          actMeal(originEl);
          break;
        case "hygiene":
          toggleHygieneMenu();
          break;
        case "homeschool":
          actHomeschool(originEl);
          break;
        case "entertain":
          actEntertain(originEl);
          break;
        case "clean":
          actClean(originEl);
          break;
        case "exercise":
          actExercise(originEl);
          break;
      }
    }

    function toggleHygieneMenu() {
      if (!hygieneMenu) return;
      hygieneMenu.classList.toggle("open");
    }

    if (hygieneMenu) {
      hygieneMenu.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-hygiene]");
        if (!btn) return;
        const type = btn.dataset.hygiene;
        actHygieneType(type, btn);
        hygieneMenu.classList.remove("open");
      });
    }

    function actHygieneType(type, originEl) {
      const n = state.needs;
      let hygieneDelta = 0;
      let energyDelta = 0;
      let xp = 0;

      if (type === "toilet") {
        hygieneDelta = -5;
        energyDelta = +1;
        xp = 4;
      } else if (type === "shower") {
        hygieneDelta = +25;
        energyDelta = -3;
        xp = 10;
        if (document.querySelector('audio[data-sound="feel-energized"]')) {
          playSound("feel-energized");
        } else {
          playSound("feel-good");
        }
      } else if (type === "teeth") {
        hygieneDelta = +10;
        xp = 6;
      } else if (type === "haircare") {
        hygieneDelta = +8;
        xp = 8;
      } else if (type === "skincare") {
        hygieneDelta = +8;
        xp = 8;
      }

      n.hygiene = clamp((n.hygiene ?? 70) + hygieneDelta, 0, 100);
      n.energy = clamp((n.energy ?? 60) + energyDelta, 0, 100);
      awardXp("selfCare", xp, originEl || hygieneMenu);
      finalizeNeedAction();
    }

    function actDrink(originEl) {
      const n = state.needs;
      n.energy = clamp((n.energy ?? 60) + 5, 0, 100);
      n.fun = clamp((n.fun ?? 60) + 2, 0, 100);
      if (document.querySelector('audio[data-sound="feel-energized"]')) {
        playSound("feel-energized");
      } else {
        playSound("feel-good");
      }
      awardXp("nourish", 4, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actSnack(originEl) {
      const n = state.needs;
      const current = n.hunger ?? 60;
      const missing = 100 - current;
      n.hunger = clamp(current + missing * 0.25, 0, 100);
      n.energy = clamp((n.energy ?? 60) - 2, 0, 100);
      awardXp("nourish", 6, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actMeal(originEl) {
      const n = state.needs;
      n.hunger = 100;
      n.energy = clamp((n.energy ?? 60) + 8, 0, 100);
      n.fun = clamp((n.fun ?? 60) + 3, 0, 100);
      if (document.querySelector('audio[data-sound="feel-energized"]')) {
        playSound("feel-energized");
      } else {
        playSound("feel-good");
      }
      awardXp("nourish", 10, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actHygiene(originEl) {
      const n = state.needs;
      n.hygiene = clamp((n.hygiene ?? 70) + 15, 0, 100);
      n.energy = clamp((n.energy ?? 60) - 3, 0, 100);
      awardXp("selfCare", 8, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actHomeschool(originEl) {
      const n = state.needs;
      n.energy = clamp((n.energy ?? 60) - 10, 0, 100);
      n.social = clamp((n.social ?? 55) + 10, 0, 100);
      n.fun = clamp((n.fun ?? 60) - 4, 0, 100);
      awardXp("mind", 12, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actEntertain(originEl) {
      const n = state.needs;
      n.fun = clamp((n.fun ?? 60) + 20, 0, 100);
      n.energy = clamp((n.energy ?? 60) - 5, 0, 100);
      awardXp("story", 8, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actClean(originEl) {
      const n = state.needs;
      n.energy = clamp((n.energy ?? 60) - 8, 0, 100);
      n.fun = clamp((n.fun ?? 60) + 3, 0, 100);
      awardXp("homestead", 10, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function actExercise(originEl) {
      const n = state.needs;
      n.energy = clamp((n.energy ?? 60) - 15, 0, 100);
      n.fun = clamp((n.fun ?? 60) + 8, 0, 100);
      awardXp("selfCare", 12, originEl || needBarLeft);
      finalizeNeedAction();
    }

    function finalizeNeedAction() {
      save();
      renderNeeds();
      recomputeMood(true);
    }

    // Feelings
    feelingGrid.addEventListener("click", (e) => {
      const card = e.target.closest(".feeling-card");
      if (!card) return;
      const key = card.dataset.feeling;
      const tone = card.dataset.tone || "neutral";
      state._lastFeeling = key;
      document
        .querySelectorAll(".feeling-card")
        .forEach((n) => n.classList.toggle("active", n === card));

      let main = "Gently okay",
        sub = "You‚Äôre doing more than enough.";

      if (key === "stressed") {
        main = "Stressed & still standing";
        sub = "Your brain is juggling a lot. Overload isn‚Äôt failure.";
      } else if (key === "overwhelmed") {
        main = "Overwhelmed, not weak";
        sub =
          "Too much on one person is a village problem, not a you problem.";
      } else if (key === "sad") {
        main = "Soft sadness";
        sub = "Heaviness is allowed; nothing about you is broken.";
      } else if (key === "angry") {
        main = "Guarding your fire";
        sub = "Anger is your boundary alarm, not proof you‚Äôre too much.";
      } else if (key === "uncomfortable") {
        main = "A bit uncomfy";
        sub = "Your body is whispering that something is off.";
      } else if (key === "scared") {
        main = "A little scared";
        sub = "Fear is your safety radar, not a character flaw.";
      } else if (key === "hungry") {
        main = "Body needs fuel";
        sub = "Feeding yourself is a family buff, not selfish.";
      } else if (key === "focused") {
        main = "Dialed in";
        sub = "You‚Äôre carrying many tabs; one tiny step at a time.";
      } else if (key === "inspired") {
        main = "Inspired spark";
        sub = "That little idea is worth keeping, even on messy days.";
      } else if (key === "happy") {
        main = "Bright & warm";
        sub = "Joy is allowed even when everything isn‚Äôt perfect.";
      } else if (key === "playful") {
        main = "Playful energy";
        sub = "You‚Äôre allowed to have fun just because.";
      } else if (key === "flirty") {
        main = "Soft flirty mood";
        sub = "You‚Äôre still a whole person with a glow of your own.";
      } else if (key === "peace") {
        main = "Tiny pocket of peace";
        sub = "Even a quiet breath on the couch counts as rest.";
      } else if (key === "ease") {
        main = "Moving with ease";
        sub = "Ease plus tiny actions is powerful.";
      }

      state.mood.labelMain = main;
      state.mood.labelSub = sub;

      if (key === "hungry")
        state.needs.hunger = clamp(state.needs.hunger - 5, 0, 100);
      if (
        ["stressed", "overwhelmed", "sad", "angry", "uncomfortable", "scared"].includes(
          key
        )
      ) {
        state.needs.energy = clamp(state.needs.energy - 5, 0, 100);
        state.needs.quiet = clamp(state.needs.quiet - 5, 0, 100);
      }
      if (
        ["happy", "playful", "flirty", "peace", "ease", "inspired"].includes(
          key
        )
      ) {
        state.needs.fun = clamp(state.needs.fun + 5, 0, 100);
      }

      if (tone === "good-playful") playSound("feel-playful");
      else if (tone === "good-flirty") playSound("feel-flirty");
      else if (tone === "good") playSound("feel-good");
      else if (tone === "low") playSound("feel-low");
      else playSound("feel-neutral");

      awardXp("mind", 5, card);
      recomputeMood(true);
      renderNeeds();
      save();
    });

    // Skills display
    function renderSkills() {
      const s = state.skills;
      overallLevelLabel.textContent = "Lv. " + s.overallLevel;
      const needOverall = xpForLevel(s.overallLevel);
      const prevOverall = xpForLevel(s.overallLevel - 1) || 0;
      const inBand = s.overallXP - prevOverall;
      const bandSize = needOverall - prevOverall || 1;
      const frac = clamp(inBand / bandSize, 0, 1);
      overallXpFill.style.width = frac * 100 + "%";
      overallXpMeta.textContent = `${s.overallXP} / ${needOverall} XP`;

      ["nourish", "selfCare", "homestead", "mind", "story"].forEach((id) => {
        const skill = s.skills[id];
        const levelSpan = document.getElementById("skillLevel-" + id);
        const fill = document.getElementById("skillFill-" + id);
        const meta = document.getElementById("skillMeta-" + id);
        if (!skill || !levelSpan || !fill || !meta) return;
        levelSpan.textContent = "Lv. " + skill.level;
        const need = xpForLevel(skill.level);
        const prev = xpForLevel(skill.level - 1) || 0;
        const band = need - prev || 1;
        const fracSkill = clamp((skill.xp - prev) / band, 0, 1);
        fill.style.width = fracSkill * 100 + "%";
        meta.textContent = `${skill.xp} / ${need} XP`;
      });
    }

    // Recipes
    function renderRecipes() {
      const filter = (recipeFilterInput.value || "").trim().toLowerCase();
      recipeList.innerHTML = "";

      const items = state.recipes.slice().sort((a, b) => {
        return (a.name || "").localeCompare(b.name || "");
      });

      items
        .filter((r) =>
          filter ? (r.category || "").toLowerCase().includes(filter) : true
        )
        .forEach((recipe) => {
          const card = document.createElement("div");
          card.className = "recipe-card";
          card.dataset.id = recipe.id;
          card.innerHTML = `
              <div class="recipe-card-header">
                <span class="recipe-card-title">${recipe.name || "Untitled recipe"}</span>
                <span class="recipe-card-cat">${recipe.category || "Uncategorized"}</span>
              </div>
              <div class="recipe-card-notes">${(recipe.notes || "")
                .replace(/\n/g, "<br>")
                .trim() || "<em>No notes yet.</em>"}</div>
            `;
          card.addEventListener("click", () => {
            document
              .querySelectorAll(".recipe-card")
              .forEach((c) => c.classList.toggle("active", c === card));
          });
          recipeList.appendChild(card);
        });

      bakingList.innerHTML = "";
      items
        .filter(
          (r) =>
            (r.category || "").toLowerCase().includes("baking")
        )
        .forEach((recipe) => {
          const card = document.createElement("div");
          card.className = "recipe-card";
          card.dataset.id = recipe.id;
          card.innerHTML = `
              <div class="recipe-card-header">
                <span class="recipe-card-title">${recipe.name || "Untitled baking"}</span>
                <span class="recipe-card-cat">${recipe.category || "Baking"}</span>
              </div>
              <div class="recipe-card-notes">${(recipe.notes || "")
                .replace(/\n/g, "<br>")
                .trim() || "<em>No notes yet.</em>"}</div>
            `;
          card.addEventListener("click", () => {
            document
              .querySelectorAll("#bakingList .recipe-card")
              .forEach((c) => c.classList.toggle("active", c === card));
          });
          bakingList.appendChild(card);
        });
    }

    recipeForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = recipeNameInput.value.trim();
      const category = recipeCategoryInput.value.trim();
      const notes = recipeNotesInput.value.trim();

      if (!name && !category && !notes) return;

      const recipe = {
        id: Date.now().toString(36),
        name: name || "Untitled recipe",
        category: category || "",
        notes: notes || ""
      };
      state.recipes.push(recipe);
      awardXp("homestead", 8, recipeForm);
      recipeNameInput.value = "";
      recipeCategoryInput.value = "";
      recipeNotesInput.value = "";
      save();
      renderRecipes();
    });

    recipeFilterInput.addEventListener("input", () => {
      renderRecipes();
    });

    // HairCare
    function renderHaircare() {
      const filter = (hairFilterInput.value || "").trim().toLowerCase();
      hairList.innerHTML = "";

      const items = state.haircare.slice().sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );

      items
        .filter((h) =>
          filter ? (h.tag || "").toLowerCase().includes(filter) : true
        )
        .forEach((hair) => {
          const card = document.createElement("div");
          card.className = "hair-card";
          card.dataset.id = hair.id;
          card.innerHTML = `
              <div class="hair-card-header">
                <span class="hair-card-title">${hair.name || "Untitled routine"}</span>
                <span class="hair-card-cat">${hair.tag || "Un-tagged"}</span>
              </div>
              <div class="hair-card-notes">${(hair.notes || "")
                .replace(/\n/g, "<br>")
                .trim() || "<em>No notes yet.</em>"}</div>
            `;
          card.addEventListener("click", () => {
            document
              .querySelectorAll(".hair-card")
              .forEach((c) => c.classList.toggle("active", c === card));
          });
          hairList.appendChild(card);
        });
    }

    hairForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = hairNameInput.value.trim();
      const tag = hairTagInput.value.trim();
      const notes = hairNotesInput.value.trim();
      if (!name && !tag && !notes) return;

      const hair = {
        id: Date.now().toString(36),
        name: name || "Untitled routine",
        tag: tag || "",
        notes: notes || ""
      };
      state.haircare.push(hair);
      awardXp("selfCare", 10, hairForm);
      hairNameInput.value = "";
      hairTagInput.value = "";
      hairNotesInput.value = "";
      save();
      renderHaircare();
    });

    hairFilterInput.addEventListener("input", () => {
      renderHaircare();
    });

    // Timers
    function renderTimers() {
      timerList.innerHTML = "";
      Object.entries(timersConfig).forEach(([id, cfg]) => {
        const timerState = state.timers[id] || { active: false, endAt: null };
        const row = document.createElement("div");
        row.className = "timer-row";
        row.dataset.timerId = id;

        const nameEl = document.createElement("div");
        nameEl.innerHTML = `<div class="timer-name">${cfg.label}</div><div class="timer-status">${timerState.active ? "Counting down" : "Off"}</div>`;

        const timeEl = document.createElement("div");
        timeEl.className = "timer-time";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "timer-btn";
        btn.textContent = timerState.active ? "Stop" : "Start";
        if (timerState.active) btn.classList.add("active");

        row.appendChild(nameEl);
        row.appendChild(timeEl);
        row.appendChild(btn);
        timerList.appendChild(row);

        btn.addEventListener("click", () => {
          toggleTimer(id, row);
        });
      });

      updateTimersDisplay();
    }

    function toggleTimer(id, row) {
      const cfg = timersConfig[id];
      if (!cfg) return;
      const t = state.timers[id];
      if (!t) return;

      const btn = row.querySelector(".timer-btn");
      const status = row.querySelector(".timer-status");

      if (t.active) {
        t.active = false;
        t.endAt = null;
        btn.textContent = "Start";
        btn.classList.remove("active");
        status.textContent = "Off";
      } else {
        const now = Date.now();
        t.active = true;
        t.endAt = now + cfg.minutes * 60000;
        btn.textContent = "Stop";
        btn.classList.add("active");
        status.textContent = "Counting down";
        awardXp(cfg.skill, 4, row);
      }
      save();
      updateTimersDisplay();
    }

    function formatRemaining(ms) {
      if (ms <= 0) return "0:00";
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const m = minutes.toString();
      const s = seconds.toString().padStart(2, "0");
      return `${m}:${s}`;
    }

    function updateTimersDisplay() {
      const now = Date.now();
      document.querySelectorAll(".timer-row").forEach((row) => {
        const id = row.dataset.timerId;
        const cfg = timersConfig[id];
        const t = state.timers[id];
        const timeEl = row.querySelector(".timer-time");
        const status = row.querySelector(".timer-status");
        const btn = row.querySelector(".timer-btn");
        if (!cfg || !t) return;

        if (!t.active || !t.endAt) {
          timeEl.textContent = "Off";
          status.textContent = "Off";
          btn.textContent = "Start";
          btn.classList.remove("active");
          return;
        }

        const remaining = t.endAt - now;
        if (remaining <= 0) {
          t.active = false;
          t.endAt = null;
          timeEl.textContent = "Time!";
          status.textContent = "Done";
          btn.textContent = "Start";
          btn.classList.remove("active");
          playSound("timer-alarm");
          awardXp(cfg.skill, 8, row);
          save();
        } else {
          timeEl.textContent = formatRemaining(remaining);
          status.textContent = "Counting down";
        }
      });
    }

    function startTimersLoop() {
      if (timersInterval) clearInterval(timersInterval);
      timersInterval = setInterval(() => {
        updateTimersDisplay();
      }, 1000);
    }

    // Initial render + intervals
    function init() {
      updateNeedsOverTime();
      renderNeeds();
      recomputeMood(false);
      renderSkills();
      renderRecipes();
      renderHaircare();
      renderTimers();
      updateTimersDisplay();
      startTimersLoop();
      fetchWeatherAndUpdateSky();
      setInterval(updateNeedsOverTime, 60000);
      setInterval(fetchWeatherAndUpdateSky, 15 * 60 * 1000);
      updateWeatherChip();
      if (bgTracks.length && bgMusic) {
        setBgTrack(currentBgIndex);
      }
      updateMusicToggle();
      if (state.bgMusicOn) {
        tryPlayBgMusic();
      }
    }

    init();
  })();
</script>
</body>
</html>



